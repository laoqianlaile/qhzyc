(function(a){a.component("coral.grid",a.coral.grid,{editCell:function(k,p,i){var j=this,r,h,f,n;if(!j.grid||j.options.cellEdit!==true){return}p=parseInt(p,10);if(!j.options.knv){a(j.element).grid("GridNav")}if(j.options.savedRow.length>0){if(i===true){if(k==j.options.iRow&&p==j.options.iCol){return}}if(j.rows[j.options.savedRow[0].id]){if(!a(j.element).grid("saveCell",j.options.savedRow[0].id,j.options.savedRow[0].ic)){return}}}else{window.setTimeout(function(){a("#"+a.grid.coralID(j.options.knv)).attr("tabindex","-1").focus()},0)}n=j.options.colModel[p];r=n.name;if(r=="subgrid"||r=="cb"||r=="rn"){return}f=a("td:eq("+p+")",j.rows[k]);if(n.editable===true&&i===true&&!f.hasClass("not-editable-cell")){if(parseInt(j.options.iCol,10)>=0&&parseInt(j.options.iRow,10)>=0){a("td:eq("+j.options.iCol+")",j.rows[j.options.iRow]).removeClass("edit-cell coral-state-highlight");a(j.rows[j.options.iRow]).removeClass("selected-row coral-state-hover")}a(f).addClass("edit-cell coral-state-highlight");a(j.rows[k]).addClass("selected-row coral-state-hover");try{h=a.unformat.call(j,f,{rowId:j.rows[k].id,colModel:n},p)}catch(o){h=(n.edittype&&n.edittype=="textarea")?a(f).text():a(f).html()}if(j.options.autoencode){h=a.grid.htmlDecode(h)}if(!j._trigger("beforeEditCell",null,[{rowId:j.rows[k].id,name:r,cellValue:h,rowIndex:k,cellIndex:p}])){return}j.options.savedRow.push({id:k,ic:p,name:r,value:h});if(h==="&nbsp;"||h==="&#160;"||(h.length===1&&h.charCodeAt(0)===160)){h=""}if(a.isFunction(j.options.formatCell)){var g=j.options.formatCell.call(j,j.rows[k].id,r,h,k,p);if(g!==undefined){h=g}}var d=n.editoptions;d=a.extend({},d||{},{id:k+"_"+r,name:r});var b=a.grid.createEl.call(j,n.edittype,d,h,true,a.extend({},a.grid.ajaxOptions,j.options.ajaxSelectOptions||{}));a(f).html("").append(b).attr("tabindex","0");var e=function(s){if(s.keyCode===27){if(a("input.hasDatepicker",f).length>0){if(a(".coral-datepicker").is(":hidden")){a(j.element).grid("restoreCell",k,p)}else{a("input.hasDatepicker",f).datepicker("hide")
}}else{a(j.element).grid("restoreCell",k,p)}}if(s.keyCode===13){a(j.element).grid("saveCell",k,p);return false}if(s.keyCode===9){if(!j.grid.columnsView.loading){if(s.shiftKey){a(j.element).grid("prevCell",k,p)}else{a(j.element).grid("nextCell",k,p)}}else{return false}}s.stopPropagation()};var m={onKeyDown:e,value:a(b).val()};switch(n.edittype){case"text":case"textarea":d=a.extend({},d,m);a(b).textbox(d);break;case"datepicker":d=a.extend({},d,m);a(b).datepicker(d);break;case"radio":d=a.extend({},d,m);a(b).radio(d);if(a(b).val()=="Yes"){a(b).radio("check")}else{a(b).radio("uncheck")}break;case"checkbox":d=a.extend({},d,m);a(b).checkbox(d);if(a(b).val()=="Yes"){a(b).checkbox("check")}else{a(b).checkbox("uncheck")}break;case"autocomplete":var l=a(b).val();var q=typeof(d.source)=="string";d=a.extend({},d,m);var c=d.postMode||"value";d.postMode=c;d=a.extend({},d,{onKeyDown:e});a(b).autocomplete(d);if(q){d.postMode="text";a(b).autocomplete(d);a(b).autocomplete("setValue",l)}else{if(c=="value"){a(b).autocomplete("setValue",l)}else{a(b).autocomplete("setValue",l);a(b).autocomplete("setText",l)}}break;case"combobox":d=a.extend({},d,m);var c=d.postMode||"value";d=a.extend({},d,{onKeyDown:e});a(b).combobox(d);a(b).combobox("setValues",[a(b).val()]);break;case"combotree":d=a.extend({},d,m);a(b).combotree(d);break;case"combogrid":d=a.extend({},d,m);a(b).combotree(d);break}window.setTimeout(function(){a(b).focus()},0);j._trigger("afterEditCell",null,[{rowId:j.rows[k].id,name:r,cellValue:h,rowIndex:k,celIndex:p}])}else{if(parseInt(j.options.iCol,10)>=0&&parseInt(j.options.iRow,10)>=0){a("td:eq("+j.options.iCol+")",j.rows[j.options.iRow]).removeClass("edit-cell coral-state-highlight");a(j.rows[j.options.iRow]).removeClass("selected-row coral-state-hover")}f.addClass("edit-cell coral-state-highlight");a(j.rows[k]).addClass("selected-row coral-state-hover");h=f.html().replace(/\&#160\;/ig,"");a(j.element).triggerHandler("jqGridSelectCell",[j.rows[k].id,r,h,k,p]);if(a.isFunction(j.options.onSelectCell)){j.options.onSelectCell.call(j,j.rows[k].id,r,h,k,p)
}}j.options.iCol=p;j.options.iRow=k},GridNav:function(){var g=this;if(!g.grid||g.options.cellEdit!==true){return}g.options.knv=g.options.id+"_kn";var f=a("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+g.options.knv+"'></span></span>"),d,c;function e(p,n,o){if(o.substr(0,1)=="v"){var h=a(g.grid.rowsView)[0].clientHeight,q=a(g.grid.rowsView)[0].scrollTop,r=g.rows[p].offsetTop+g.rows[p].clientHeight,l=g.rows[p].offsetTop;if(o=="vd"){if(r>=h){a(g.grid.rowsView)[0].scrollTop=a(g.grid.rowsView)[0].scrollTop+g.rows[p].clientHeight}}if(o=="vu"){if(l<q){a(g.grid.rowsView)[0].scrollTop=a(g.grid.rowsView)[0].scrollTop-g.rows[p].clientHeight}}}if(o=="h"){var k=a(g.grid.rowsView)[0].clientWidth,j=a(g.grid.rowsView)[0].scrollLeft,i=g.rows[p].cells[n].offsetLeft+g.rows[p].cells[n].clientWidth,m=g.rows[p].cells[n].offsetLeft;if(i>=k+parseInt(j,10)){a(g.grid.rowsView)[0].scrollLeft=a(g.grid.rowsView)[0].scrollLeft+g.rows[p].cells[n].clientWidth}else{if(m<j){a(g.grid.rowsView)[0].scrollLeft=a(g.grid.rowsView)[0].scrollLeft-g.rows[p].cells[n].clientWidth}}}}function b(l,h){var k,j;if(h=="lft"){k=l+1;for(j=l;j>=0;j--){if(g.options.colModel[j].hidden!==true){k=j;break}}}if(h=="rgt"){k=l-1;for(j=l;j<g.options.colModel.length;j++){if(g.options.colModel[j].hidden!==true){k=j;break}}}return k}a(f).insertBefore(g.grid.columnsView);a("#"+g.options.knv).focus().keydown(function(h){c=h.keyCode;if(g.options.direction=="rtl"){if(c===37){c=39}else{if(c===39){c=37}}}switch(c){case 38:if(g.options.iRow-1>0){e(g.options.iRow-1,g.options.iCol,"vu");a(g.element).grid("editCell",g.options.iRow-1,g.options.iCol,false)}break;case 40:if(g.options.iRow+1<=g.rows.length-1){e(g.options.iRow+1,g.options.iCol,"vd");a(g.element).grid("editCell",g.options.iRow+1,g.options.iCol,false)}break;case 37:if(g.options.iCol-1>=0){d=b(g.options.iCol-1,"lft");e(g.options.iRow,d,"h");a(g.element).grid("editCell",g.options.iRow,d,false)
}break;case 39:if(g.options.iCol+1<=g.options.colModel.length-1){d=b(g.options.iCol+1,"rgt");e(g.options.iRow,d,"h");a(g.element).grid("editCell",g.options.iRow,d,false)}break;case 13:if(parseInt(g.options.iCol,10)>=0&&parseInt(g.options.iRow,10)>=0){a(g.element).grid("editCell",g.options.iRow,g.options.iCol,true)}break;default:return true}return false})},saveCell:function(g,f){var i=this,h;if(!i.grid||i.options.cellEdit!==true){return}if(i.options.savedRow.length>=1){h=0}else{h=null}if(h!==null){var q=a("td:eq("+f+")",i.rows[g]),o,b,k=i.options.colModel[f],c=k.name,j=a.grid.coralID(c);if(this.options.autoValid){var x=this.valid(i.rows[g].id,k.name);if(!this.options.allowSaveOnError&&!x){a.message("请确认是否输入正确！");return x}}var r=k.edittype;switch(r){case"select":if(!k.editoptions.multiple){o=a("#"+g+"_"+j+" option:selected",i.rows[g]).val();b=a("#"+g+"_"+j+" option:selected",i.rows[g]).text()}else{var w=a("#"+g+"_"+j,i.rows[g]),u=[];o=a(w).val();if(o){o.join(",")}else{o=""}a("option:selected",w).each(function(e,v){u[e]=a(v).text()});b=u.join(",")}if(k.formatter){b=o}break;case"checkbox":var s=["Yes","No"];if(k.editoptions){s=k.editoptions.value.split(":")}o=a("#"+g+"_"+j,i.rows[g]).is(":checked")?s[0]:s[1];b=o;break;case"password":case"text":case"textarea":o=a("#"+g+"_"+j,i.rows[g]).val();b=o;break;case"button":o=a("#"+g+"_"+j,i.rows[g]).val();b=o;break;case"custom":try{if(k.editoptions&&a.isFunction(k.editoptions.custom_value)){o=k.editoptions.custom_value.call(i,a(".customelement",q),"get");if(o===undefined){throw"e2"}else{b=o}}else{throw"e1"}}catch(y){if(y=="e1"){a.grid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.grid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(y=="e2"){a.grid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.grid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{a.grid.info_dialog(jQuery.jgrid.errors.errcap,y.message,jQuery.jgrid.edit.bClose)}}break;case"datepicker":o=a("#"+g+"_"+j,i.rows[g]).val();b=o;var B=a("#"+g+"_"+j,i.rows[g]);
break;case"combobox":case"combotree":o=a("#"+g+"_"+j,i.rows[g])[r]("getValues").toString();b=a("#"+g+"_"+j,i.rows[g])[r]("getText");if(k.formatter){b=o}break;case"autocomplete":b=a("#"+g+"_"+j,i.rows[g])[r]("getText");if(typeof(k.editoptions.source)=="string"){o=b}else{o=a("#"+g+"_"+j,i.rows[g])[r]("getValue")}if(k.formatter&&k.postMode=="value"){b=o}break}if(b!==i.options.savedRow[h].value){var A=a(i).triggerHandler("jqGridBeforeSaveCell",[i.rows[g].id,c,o,g,f]);if(A){o=A;b=A}if(a.isFunction(i.options.beforeSaveCell)){var t=i.options.beforeSaveCell.call(i,i.rows[g].id,c,o,g,f);if(t){o=t;b=t}}var d=a.grid.checkValues(o,f,i);if(d[0]===true){var m=a(i).triggerHandler("jqGridBeforeSubmitCell",[i.rows[g].id,c,o,g,f])||{};if(a.isFunction(i.options.beforeSubmitCell)){m=i.options.beforeSubmitCell.call(i,i.rows[g].id,c,o,g,f);if(!m){m={}}}if(a("input.hasDatepicker",q).length>0){a("input.hasDatepicker",q).datepicker("hide")}if(i.options.cellsubmit=="remote"){if(i.options.cellurl){var z={};if(i.options.autoencode){o=a.grid.htmlEncode(o)}z[c]=o;var p,n,l;l=i.options.prmNames;p=l.id;n=l.oper;z[p]=a.grid.stripPref(i.options.idPrefix,i.rows[g].id);z[n]=l.editoper;z=a.extend(m,z);a("#lui_"+a.grid.coralID(i.options.id)).show();i.grid.columnsView.loading=true;a.ajax(a.extend({url:i.options.cellurl,data:a.isFunction(i.options.serializeCellData)?i.options.serializeCellData.call(i,z):z,type:"POST",complete:function(e,C){a("#lui_"+i.options.id).hide();i.grid.columnsView.loading=false;if(C=="success"){var v=a(i).triggerHandler("jqGridAfterSubmitCell",[i,e,z.id,c,o,g,f])||[true,""];if(v[0]===true&&a.isFunction(i.options.afterSubmitCell)){v=i.options.afterSubmitCell.call(i,e,z.id,c,o,g,f)}if(v[0]===true){a(q).empty();a(i.element).grid("setCell",i.rows[g].id,f,b,false,false,true);a(q).addClass("dirty-cell");a(i.rows[g]).addClass("edited");a(i).triggerHandler("jqGridAfterSaveCell",[i.rows[g].id,c,o,g,f]);if(a.isFunction(i.options.afterSaveCell)){i.options.afterSaveCell.call(i,i.rows[g].id,c,o,g,f)
}i.options.savedRow.splice(0,1)}else{a.grid.info_dialog(a.grid.errors.errcap,v[1],a.grid.edit.bClose);a(i.element).grid("restoreCell",g,f)}}},error:function(e,v,C){a("#lui_"+a.grid.coralID(i.options.id)).hide();i.grid.columnsView.loading=false;a(i).triggerHandler("jqGridErrorCell",[e,v,C]);if(a.isFunction(i.options.errorCell)){i.options.errorCell.call(i,e,v,C);a(i.element).grid("restoreCell",g,f)}else{a.grid.info_dialog(a.grid.errors.errcap,e.status+" : "+e.statusText+"<br/>"+v,a.grid.edit.bClose);a(i.element).grid("restoreCell",g,f)}}},a.grid.ajaxOptions,i.options.ajaxCellOptions||{}))}else{try{a.grid.info_dialog(a.grid.errors.errcap,a.grid.errors.nourl,a.grid.edit.bClose);a(i.element).grid("restoreCell",g,f)}catch(y){}}}if(i.options.cellsubmit=="clientArray"){a(q).empty();a(i.element).grid("setCell",i.rows[g].id,f,b,false,false,true);a(q).addClass("dirty-cell");a(i.rows[g]).addClass("edited");i._trigger("afterSaveCell",null,[{rowId:i.rows[g].id,name:c,cellValue:o,rowIndex:g,celIndex:f}]);i.options.savedRow.splice(0,1)}}else{try{window.setTimeout(function(){a.grid.info_dialog(a.grid.errors.errcap,o+" "+d[1],a.grid.edit.bClose)},100);a(i.element).grid("restoreCell",g,f)}catch(y){}}}else{a(i.element).grid("restoreCell",g,f)}}if(false){a("#"+a.grid.coralID(i.options.knv)).attr("tabindex","-1").focus()}else{window.setTimeout(function(){a("#"+a.grid.coralID(i.options.knv)).attr("tabindex","-1").focus()},0)}},restoreCell:function(e,c){var d=this,b;if(!d.grid||d.options.cellEdit!==true){return}if(d.options.savedRow.length>=1){b=0}else{b=null}if(b!==null){var f=a("td:eq("+c+")",d.rows[e]);a(f).empty().attr("tabindex","-1");a(d.element).grid("setCell",d.rows[e].id,c,d.options.savedRow[b].value,false,false,true);a(d).triggerHandler("jqGridAfterRestoreCell",[d.rows[e].id,d.options.savedRow[b].value,e,c]);if(a.isFunction(d.options.afterRestoreCell)){d.options.afterRestoreCell.call(d,d.rows[e].id,d.options.savedRow[b].value,e,c)}d.options.savedRow.splice(0,1)}window.setTimeout(function(){a("#"+d.options.knv).attr("tabindex","-1").focus()
},0)},nextCell:function(e,b){var d=this,f=false;if(!d.grid||d.options.cellEdit!==true){return}for(var c=b+1;c<d.options.colModel.length;c++){if(d.options.colModel[c].editable===true){f=c;break}}if(f!==false){a(d.element).grid("editCell",e,f,true)}else{if(d.options.savedRow.length>0){a(d.element).grid("saveCell",e,b)}}},prevCell:function(e,b){var d=this,f=false;if(!d.grid||d.options.cellEdit!==true){return}for(var c=b-1;c>=0;c--){if(d.options.colModel[c].editable===true){f=c;break}}if(f!==false){a(d.element).grid("editCell",e,f,true)}else{if(d.options.savedRow.length>0){a(d.element).grid("saveCell",e,b)}}},getChangedCells:function(f){var c=[];if(!f){f="all"}var d=this,b,e=true;if(!d.grid||d.options.cellEdit!==true){return}a(d.rows).each(function(g){var h={};if(a(this).hasClass("edited")){a("td",this).each(function(j){b=d.options.colModel[j].name;if(b!=="cb"&&b!=="subgrid"){if(a(this).hasClass("coral-gridcell-error")){e=false;return false}if(f=="dirty"){if(a(this).hasClass("dirty-cell")){try{h[b]=a.unformat.call(d,this,{rowId:d.rows[g].id,colModel:d.options.colModel[j]},j)}catch(k){h[b]=a.jgrid.htmlDecode(a(this).html())}}}else{try{h[b]=a.unformat.call(d,this,{rowId:d.rows[g].id,colModel:d.options.colModel[j]},j)}catch(k){h[b]=a.jgrid.htmlDecode(a(this).html())}}}});if(!e){return false}h.id=this.id;c.push(h)}});if(!e){c=[]}return c}})})(jQuery);