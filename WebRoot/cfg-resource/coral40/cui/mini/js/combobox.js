(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./combo"],a)}else{a(jQuery)}}(function(a,b){var c=0;a.component("coral.combobox",a.coral.combo,{version:"4.0.3",castProperties:["data","buttons"],options:{cls:"",valueField:"value",textField:"text",panelRenderOnShow:false,mode:"local",method:"post",url:null,data:[],buttons:[],width:"auto",showText:true,emptyText:null,postMode:"value",formatter:function(e){var d=a(this).combobox("option","textField");return e[d]},loader:function(i,h,f){var g=this,d=a(this),e=d.combobox("option","url");if(!e){return false}a.ajax({type:d.combobox("option","method"),url:e,data:i,dataType:"json",success:function(j){h(j)},error:function(){f.apply(this,arguments)}});return false},beforeLoad:a.noop,onLoad:a.noop,onError:a.noop,onShowPanel:a.noop,beforeSelect:a.noop,onSelect:a.noop,unSelect:a.noop},_create:function(){var d=this,g=null;var f=new Date();this.data=this.data||[];c++;d.options.itemIdPrefix="combobox_i"+c;this.element.addClass("coral-form-element-combobox coral-validation-combobox ctrl-form-element");var e=a.coral.toFunction(this.options.onShowPanel);g=function(h){e.apply(d.element,[h]);d._scrollTo(d.getValue())};this.options.onShowPanel=g;this._super();this._on(this.uiCombo.panel,{mouseover:function(h){a(h.target).closest(".coral-combobox-item").addClass("coral-combobox-item-hover")},mouseout:function(h){a(h.target).closest(".coral-combobox-item").removeClass("coral-combobox-item-hover")},mousedown:function(l){this.cancelBlur=true;this._delay(function(){delete this.cancelBlur});var j=a(l.target).closest(".coral-combobox-item"),k=j.attr("value");if(a(l.target).closest(".coral-combo-filterbox").length){return}if(!j.length||j.hasClass("coral-combobox-item-disabled")){return false}var h=this.getRowIndex(k);if(false===this._trigger("beforeSelect",null,[{item:this.options.data[h]},{data:this.options.data[h]}])){return false}if(this.options.multiple){this.oldText=this.uiCombo.textbox.val();if(""===k){this.clear();this.hidePanel();
this.select(k)}else{if(this.options.emptyText){this.unselect("")}if(j.hasClass("coral-combobox-item-selected")){this.unselect(k);j.removeClass("coral-combobox-item-selected")}else{this.select(k)}}}else{this.oldText=this.uiCombo.textbox.val();this.hidePanel();this.select(k)}return false}});if(this.options.isLabel&&this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}},_initData:function(){if(this.options.url){return this._request(this.options.url)}if(this.options.data.length){return this.loadData(this.options.data)}return this.loadData(this._transformData())},_renderItems:function(y){var o=this.options,m=this.panel(),j=this,f={},r=[],n=[],u,d="",g=a.coral.toFunction(this.options.formatter),k=a.coral.toFunction(this.options.itemattr);for(u=0;u<y.length;u++){var h=y[u],l=h[o.valueField],p=h[o.textField],x=!!h.hidden==true?"hidden":"",w="",e=p;if(g){e=g.call(this.element,y[u])}if(a.isFunction(k)){var q=k.apply(this.element[0],[{item:y[u]}]);if(!a.isEmptyObject(q)){if(q.hasOwnProperty("style")){w+=q.style;delete q.style}if(q.hasOwnProperty("class")){x+=" "+q["class"];delete q["class"]}try{delete q.role}catch(t){}for(attrName in q){if(q.hasOwnProperty(attrName)){d+=" "+attrName+"="+q[attrName]}}}n.push("<div class='coral-combobox-item "+x+d+"' style='"+w+"' id='"+this.options.itemIdPrefix+"_"+u+"' value='"+l+"'>"+e+"</div>")}else{n.push("<div class='coral-combobox-item "+x+" ' id='"+this.options.itemIdPrefix+"_"+u+"' value='"+l+"'>"+e+"</div>")}if(h.selected&&a.inArray(l,r)===-1){r.push(this.getModeValue(l,p))}}this.lazyPanelHtml=n.join("");return r},loadData:function(h,i,n){var d=this.options,e=this.panel(),j=this,f=n||"onLoad",p=a.coral.toFunction(this.options.formatter),k={},g=[],l=false,m=null;if(!(h instanceof Array)){h=[]}this.data=(h||[]);if(d.clearOnLoad){l=j._clearValues(this.data)}this.uiCombo.pContent.empty();if(this.options.emptyText){if(!(h.length>0&&""===h[0][this.options.valueField])){k[this.options.valueField]="";k[this.options.textField]=this.options.emptyText;
h.unshift(k)}}var o=[];if(!this.options.panelRenderOnShow){g=this._renderItems(this.data);this.uiCombo.pContent.html(this.lazyPanelHtml);this.panelRendered=true}if(this.currentValues.length&&!l){g=this.currentValues}if(!this.isInit){this.isInit=true;this.originalValue=g.join(",")}this.dataLoaded=true;if(d.multiple){this.setValues(g,false,i)}else{g=g.length?[g[0]]:[];this.setValues(g,false,i)}this._trigger(f,null,[h])},localFilter:function(j){var h=this.getData(),g=this.panel().find(".coral-combobox-item");for(var e=0;e<h.length;e++){a(g[e]).hide();if(j.apply(this.element,[h[e]])){var d=h[e][this.options.valueField];var f=h[e][this.options.textField];a(g[e]).show()}}},_scrollTo:function(g){var d=this.panel().find(".coral-combo-content"),e;var f=this.getEl(g);if(f.length){if(f.position().top<=0){e=d.scrollTop()+f.position().top;d.scrollTop(e)}else{if(f.position().top+f.outerHeight()>d.height()){e=d.scrollTop()+f.position().top+f.outerHeight()-d.height();d.scrollTop(e)}}}},_transformData:function(){var d=this.options;var e=[];a(">option",this.element).each(function(){var f={};f[d.valueField]=a(this).attr("value")!==b?a(this).attr("value"):a(this).html();f[d.textField]=a(this).html();f.selected=a(this).attr("selected");e.push(f)});return e},_showItems:function(){this.uiCombo.panel.find(".coral-combobox-item").show()},_doQuery:function(g){var e=this.options,p=this.options.filter;if(e.mode=="remote"){this._request(null,{q:g},true)}else{var f=this.panel();var k=this.getData(),s=f.find(".coral-combobox-item");s.hide();this._removeHighlight(this.uiCombo.pContent.find("span.coral-keyword-highlight"));this.uiCombo.pContent.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");this.uiCombo.pContent.find(".coral-item-focus").removeClass("coral-item-focus");for(var l=0;l<k.length;l++){var m=pinyinEngine.toPinyin(k[l][e.textField],false,"");for(var h=0;h<g.length;h++){var d=p.apply(this.element,[g[h],k[l]]);if(d){var n=k[l][e.valueField].toString();var o=k[l][e.textField];
if(o.indexOf(g[h])>-1||n.indexOf(g[h])>-1||m.indexOf(g[h])>-1){a(s[l]).show();if(o==g[h]){a(s[l]).addClass("coral-combobox-item-selected");this._removeHighlight(a(s[l]).find("span.coral-keyword-highlight"))}else{if(d=="text"){this._addHighlight(a(s[l]),g[h])}}}}}}}},_checkMathch:function(s,t){var d=[],r=[];var e=this.options,g=e.textField,u=e.valueField;var q=0;if(t){this._showItems()}var f=false;var n=this.data,l="",h={},o=0,m,k;if(e.multiple){for(m=0;m<s.length;m++){for(k=0;k<n.length;k++){if(n[k][g]!=s[m]&&n[k][u]!=s[m]){h[m.toString()]=true}if(n[k][g]==s[m]){l=this.getModeValue(n[k][u],n[k][g]);d.push(l);f=true;break}}if(!f&&!e.forceSelection){if((!h[m.toString()]&&!t)||t){d.push(s[m]);r.push(s[m])}}f=false}}else{var p=-1;for(m=0;m<n.length;m++){if(n[m][g]==s[0]){p=p===-1?m:p;f=true}if(n[m][g]!=s[0]&&n[m][u]!=s[0]){h["0"]=true}}if(f){l=this.getModeValue(n[p][u],n[p][g]);d.push(l)}if(!f&&!e.forceSelection){if((!h["0"]&&!t)||t){d.push(s[0]);r.push(s[0])}}}return{valarr:d,textarr:r}},_request:function(f,g,i){var j=this,d={},h=[],e=this.options.loader,l=false;if(!f&&!j.options.url){f=[]}else{if(!f&&j.options.url){f=j.options.url}}if(typeof(f)!=="string"){d=f;if(d.data){h=d.data}else{if(d.url){f=d.url;j.options.url=d.url;l=true}else{if(d instanceof Array){h=f}else{if(!d.url&&!d.data&&!j.options.url){h=[]}else{if(!d.url&&!d.data&&j.options.url){f=j.options.url;l=true}}}}}}else{j.options.url=f;l=true}if(l){g=g||{};if(this._trigger("beforeLoad",null,[g])==false){return}e.apply(this.element,[g,function(n){var m=d.onLoad;j.loadData(n,i,m);j._loadedHandler()},function(){j._trigger("onError",null,arguments)}])}else{var k=d.onLoad;j.loadData(h,i,k)}},_loadedHandler:function(){var e=this;var d=this._getCacheItem("setValues");if(d){this.setValues(d.values,d.triggerOnChange,d.remainText);this._removeCacheItem("setValues")}var f=this._getCacheItem("focus");if(f){this._removeCacheItem("focus")}},_selectItems:function(e,j){var g=this.panel(),h=null,i=null,f=g.find(".coral-item-focus:visible"),d=":last";
if(e){d=":first"}f.removeClass("coral-item-focus");if(f.length){i=f.attr("value")}else{f=h=g.find(".coral-combobox-item-selected:visible"+d);if(h.length){i=h.attr("value")}}if(j=="prev"){if(f.prevAll(":visible").length===0){f=g.find(".coral-combobox-item:visible:last");f.addClass("coral-item-focus")}else{f.prevAll(":visible:eq(0)").addClass("coral-item-focus")}}else{if(f.nextAll(":visible").length===0){f=g.find(".coral-combobox-item:visible:first");f.addClass("coral-item-focus")}else{f.nextAll(":visible:eq(0)").addClass("coral-item-focus")}}return i},_selectPrev:function(){var d=this.panel(),g=this._selectItems(true,"prev"),f=d.find('.coral-combobox-item[value="'+g+'"]'),e=null,h=null;if(f.length){e=f.prevAll(":visible:eq(0)")}else{f=d.find(".coral-combobox-item:visible:last")}if(null!==e&&e.length===0){e=d.find(".coral-combobox-item:visible:last")}h=!!e?e.attr("value"):f.attr("value");this.select(h);this._scrollTo(h)},_selectNext:function(){var d=this.panel(),g=this._selectItems(true,"next"),f=d.find('.coral-combobox-item[value="'+g+'"]'),e=null,h=null;if(f.length){e=f.nextAll(":visible:eq(0)")}else{f=d.find(".coral-combobox-item:visible:first")}if(e&&e.length==0){e=d.find(".coral-combobox-item:visible:first")}h=e?e.attr("value"):f.attr("value");this.select(h);this._scrollTo(h)},_doEnter:function(l){var f=this.panel(),n=this.getValues(),o=f.find(".coral-item-focus:visible"),j,h=this.getData(),d=this.options,m=o.attr("value");if(m){var g="",k=0;for(j=0;j<h.length;j++){if(m==h[j][d.valueField]){k=j}}g=this.getModeValue(m,h[k][d.textField]);if(this.options.multiple){if(a.inArray(g,n)==-1){this.select(m)}else{this.unselect(m)}}else{this.hidePanel()}}},_formatValue:function(j){var h=this.getData(),g=this.options,e=g.valueField,d=g.textField,f=0,k=null;if("text"===g.postMode||"value-text"===g.postMode){for(f=0;f<h.length;f++){k=h[f];if(""!=j&&j==k[e]){if("text"===g.postMode){return k[d]}if("value-text"===g.postMode){return j+g.valueTextSeparator+k[d]}}}}return j},_destroy:function(){this.element.removeClass("coral-validation-combobox");
this.element.removeClass("coral-form-element-combobox");this._super()},_getOnlyValues:function(){var h=this.getData(),d=this.options,e=[],k=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return e}for(;k<this.currentValues.length;k++){var l=this.currentValues[k],g=0,m=d.valueField,f=d.textField,n=null;if("value-text"===d.postMode){l=l.split(d.valueTextSeparator)[0];e.push(l)}if("value"===d.postMode){e.push(l)}if("text"===d.postMode){for(;h&&g<h.length;g++){n=h[g];if(n[f]==l){e.push(n[m]);break}}}}return e},_getCurrentValues:function(){var g=this.getData(),f=this.options,e=[],d=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return e}return this.currentValues},getData:function(){return this.data||[]},setValues:function(d,p,g){var o=this.options,w=this.getData(),l=this.panel(),r=g,t=0,s=0,v=this.getValues()||[],k=[],m=[],u=null,q=null,n=null;if(typeof(r)=="object"){g=r.remainText;p=r.triggerOnChange}this.currentValues=d;if(!this.dataLoaded){return}l.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");for(t=0;t<d.length;t++){q=d[t];n=q;var f=this.getRowIndex(q);if(f>-1){n=w[f][o.textField];u=w[f][o.valueField];var e=this._getItemByIndex(f).addClass("coral-combobox-item-selected");if(o.emptyText&&""==q){this.uiCombo.textbox.attr("placeholder",o.emptyText);this._showPlaceholder(o.emptyText);n=""}else{this._hidePlaceholder()}m.push(n);k.push(q)}else{if(f<0&&!o.forceSelection){m.push(n);k.push(q)}}}if(!g){this._setText(m.join(o.separator))}var h=this._getMinus(k,d);if((h.length&&k.length)||!k.length){m=m.concat(h);if(!g){this._setText(m.join(o.separator))}k=d}this._super(k,p,g)},_getMinus:function(e,d){var f=[];a.each(d,function(g,h){if(a.inArray(h,e)==-1){f.push(h)}});return f},getEl:function(e){var d=this.getRowIndex(e);var f=d;return a("#"+this.options.itemIdPrefix+"_"+f)},_getItemByIndex:function(d){var e=d;return a("#"+this.options.itemIdPrefix+"_"+e)},getRowIndex:function(h){var f=this.options,g=this.getData(),d=f.postMode;
for(var e=0;e<g.length;e++){if(d=="value"){if(g[e][f.valueField]==h){return e}}if(d=="text"){if(g[e][f.textField]==h){return e}}if(d=="value-text"){if(g[e][f.valueField]==h.split(f.valueTextSeparator)[0]){return e}}}return -1},clear:function(){var d=this.panel();this._super();d.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");d.find(".coral-item-focus").removeClass("coral-item-focus")},reload:function(d){this._request(d)},select:function(j){var g=this.options,h=this.getData(),f,d;j=a.trim(j);if(g.multiple){d=this.getValues()}else{d=[]}var e="",k=0;for(f=0;f<h.length;f++){if(j==h[f][g.valueField]){k=f}}e=this.getModeValue(j,h[k][g.textField]);for(f=0;f<d.length;f++){if(d[f]==e){return}}d.push(e);this.setValues(d,true,false);this._trigger("onSelect",null,[{item:h[k],value:j,text:h[k][g.textField]}])},getModeValue:function(e,f){var d;if(this.options.postMode=="value"){d=e}if(this.options.postMode=="text"){d=f}if(this.options.postMode=="value-text"){d=e+"-"+f}return d},unselect:function(h){var f=this.options,g=this.getData(),d=this.getValues(),e;var j=0;for(e=0;e<g.length;e++){if(h==g[e][f.valueField]){j=e}}if(this.options.postMode=="value"){h=h}if(this.options.postMode=="text"){h=g[j][f.textField]}if(this.options.postMode=="value-text"){h=h+"-"+g[j][f.textField]}for(e=0;e<d.length;e++){if(d[e]==h){d.splice(e,1);this.setValues(d,true,false);this._trigger("onSelect",null,[{item:g[j],value:h,text:g[j][f.textField]}]);break}}},showPanel:function(){this._removeHighlight(this.uiCombo.pContent.find("span.coral-keyword-highlight"));var d=0,e;this._super();if(!this.hideValueArr){return}for(;d<this.hideValueArr.length;d++){e=this.hideValueArr[d];this.uiCombo.pContent.find('.coral-combobox-item[value="'+e+'"]').hide()}},addOption:function(j){var l=this,g=0,k=null,f=this.options.valueField,d=this.options.textField,e=j[f],h=j[d];if(!(f in j)||!(d in j)){if(a.message){a.message("JSON格式不正确!")}return false}for(g=0;g<this.data.length;g++){if((j[f]==this.data[g][f])||(j[d]==this.data[g][d])){if(a.message){a.message("当前选项已存在!")
}return false}}k=a('<div class="coral-combobox-item"></div>');k.attr("value",e);if(this.options.formatter){k.html(this.options.formatter.call(this.element,j))}else{k.html(h)}if(this.data.length>0&&""==this.data[0][f]){this.data.splice(1,0,j);k.insertAfter(this.uiCombo.pContent.find(":first-child"))}else{this.data.unshift(j);k.prependTo(this.uiCombo.pContent)}return true},removeOption:function(f){var h=null,g=null,e=0,d=this.options.valueField,j=null;if(typeof f==="number"){if(f>this.data.length){return}h=this.data[e];j=f}if(typeof f==="string"){g=f}if(typeof f==="object"){if(!(d in f)){return}g=f[d]}if(g!==null){for(;e<this.data.length;e++){if(g==this.data[e][d]){h=this.data[e];j=e;break}}}if(j!==null){this.data.splice(j,1);this.uiCombo.pContent.find('.coral-combobox-item[value="'+g+'"]').remove()}},clearOptinons:function(){this.uiCombo.pContent.empty();this.clear()},showOption:function(d){var e;if(typeof d==="number"){e=this.uiCombo.pContent.find(".coral-combobox-item:eq("+d+")")}else{if(typeof d==="string"){e=this.uiCombo.pContent.find('.coral-combobox-item[value="'+d+'"]')}else{if(typeof d==="object"){if(!(this.options.valueField in d)){return}e=this.uiCombo.pContent.find('.coral-combobox-item[value="'+d[this.options.valueField]+'"]')}else{this.uiCombo.pContent.find(".coral-combobox-item").removeClass("hidden");this.hideValueArr=null}}}if(e&&e.length>0){e.removeClass("hidden");if(this.hideValueArr){this.hideValueArr.splice(a.inArray(e.attr("value"),this.hideValueArr),1)}}},hideOption:function(d){if(!this.hideValueArr){this.hideValueArr=[]}var e;if(typeof d==="number"){e=this.uiCombo.pContent.find(".coral-combobox-item:eq("+d+")")}else{if(typeof d==="string"){e=this.uiCombo.pContent.find('.coral-combobox-item[value="'+d+'"]')}else{if(!(this.options.valueField in d)){return}e=this.uiCombo.pContent.find('.coral-combobox-item[value="'+d[this.options.valueField]+'"]')}}if(e&&e.length>0){e.addClass("hidden");this.hideValueArr.push(e.attr("value"))}}})}));