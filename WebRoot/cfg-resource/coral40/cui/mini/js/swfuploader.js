(function(a){a.component("coral.swfuploader",{options:{swfUploadOptions:null,swf:"external/swfupload.swf",uploader:"swfupload.php",auto:true,buttonClass:"",buttonCursor:"hand",buttonImage:null,buttonText:"SELECT FILES",checkExisting:false,debug:false,fileObjName:"Filedata",maxFileSize:0,fileTypeDesc:"All Files",fileTypeExts:"*.*",uploadTemplate:false,method:"post",multiple:true,formData:{},preventCaching:true,uploadedFileList:[],separator:",",progressData:"speed",queueID:false,queueSizeLimit:999,removeCompleted:true,removeTimeout:3,requeueErrors:false,successTimeout:30,uploadLimit:999,overrideEvents:[]},_create:function(){var k=this,l=this.element.clone(),c=this.options;this.options.id=this.element.attr("id");var j=a("<div />",{id:c.id+"_wrappper","class":"swfuploader",css:{height:c.height+"px",width:c.width+"px"}});this.element.append(j);var b={assume_success_timeout:c.successTimeout,button_placeholder_id:j[0].id,button_width:c.width,button_height:c.height,button_text:null,button_text_style:null,button_text_top_padding:0,button_text_left_padding:0,button_action:(c.multiple?SWFUpload.BUTTON_ACTION.SELECT_FILES:SWFUpload.BUTTON_ACTION.SELECT_FILE),button_disabled:false,button_cursor:(c.buttonCursor=="arrow"?SWFUpload.CURSOR.ARROW:SWFUpload.CURSOR.HAND),button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,debug:c.debug,requeue_on_error:c.requeueErrors,file_post_name:c.fileObjName,file_size_limit:c.maxFileSize,file_types:c.fileTypeExts,file_types_description:c.fileTypeDesc,file_queue_limit:c.queueSizeLimit,file_upload_limit:c.uploadLimit,flash_url:c.swf,prevent_swf_caching:c.preventCaching,post_params:c.formData,upload_url:c.uploader,use_query_string:(c.method=="get"),swfupload_loaded_handler:c.onSWFReady,file_dialog_complete_handler:this.onDialogClose,file_dialog_start_handler:this.onDialogOpen,file_queued_handler:function(n){k.onSelect.apply(k,[this,n])},file_queue_error_handler:function(n,p,o){k.onSelectError.apply(k,[this,n,p,o])},upload_complete_handler:function(n){k.onUploadComplete.apply(k,[this,n])
},upload_error_handler:function(n,p,o){k.onUploadError.apply(k,[this,n,p,o])},upload_progress_handler:function(o,p,n){k.onUploadProgress.apply(k,[this,o,p,n])},upload_start_handler:function(n){k.onUploadStart.apply(k,[this,n])},upload_success_handler:function(o,p,n){k.onUploadSuccess.apply(k,[this,o,p,n])}};if(c.swfUploadOptions){b=a.extend(b,c.swfUploadOptions)}b=a.extend(b,c);var m=swfobject.getFlashPlayerVersion();var d=(m.major>=9);if(d){window["swfuploader_"+c.id]=new SWFUpload(b);var e=window["swfuploader_"+c.id];this.element.data("swfuploader",e);a("#"+e.movieName).wrap(j);j=a("#"+c.id);j.data("swfuploader",e);a("#"+e.movieName).css({position:"absolute","z-index":1});if(!c.queueID){var h=a("<div />",{id:c.id+"-queue","class":"swfuploader-queue"});j.after(h);e.settings.queueID=c.id+"-queue";e.settings.defaultQueue=true}e.queueData={files:{},filesSelected:0,filesQueued:0,filesReplaced:0,filesCancelled:0,filesErrored:0,uploadsSuccessful:0,uploadsErrored:0,averageSpeed:0,queueLength:0,queueSize:0,uploadSize:0,queueBytesUploaded:0,uploadQueue:[],errorMsg:"Some files were not added to the queue:"};e.original=l;e.wrapper=j;e.queue=h;if(c.onInit){c.onInit.call(this.element,e)}}else{var g=c.onNoflash.call(this.element);var i=a("<div class='coral-uploader-button' style='height: 40px;'></div>").appendTo(g);var f=a("<input type='button'/>").appendTo(i);f.button({id:c.id+"-button",label:c.buttonText,onClick:function(){alert("没有安装flash或flash版本过低")}})}},addUploadCount:function(){var b=this.element.data("swfuploader");b.addUploadCount()},reduece:function(b){var e=this.element.data("swfuploader"),d=e.settings;if(a("#"+b).hasClass("template-download")){e.reduceUploadCount();uploadList=d.uploadedFileList;var c=this.getValues();uploadList.splice(a.inArray(b,c),1)}else{if(a("#"+b).hasClass("template-upload")){downList=d.unUploadedFileList;var c=this.getUnUploadValues();downList.splice(a.inArray(b,c),1)}}},setValues:function(b){var d=this.element.data("swfuploader"),c=d.settings;c.uploadedFileList=b
},cancel:function(i,k){var j=arguments,d,b,h=this;var f=this.element.data("swfuploader"),e=f.settings,g=-1;if(!e.disabled){if(typeof i==="array"||typeof i==="undefined"){if(typeof i==="undefined"){var o=f.queueData.queueLength;a("#"+e.queueID).children().each(function(){g++;if(j[1]===true){f.cancelUpload(this.id,false)}else{f.cancelUpload(this.id)}a(this).find(".data").removeClass("data");a(this).delay(1000+100*g).fadeOut(500,function(){a(this).remove()});h._trigger("onRemove",null);delete f.queueData.files[this.id];h.reduece(this.id)});f.queueData.queueSize=0;f.queueData.queueLength=0;if(e.onClearQueue){e.onClearQueue.call(this.element,o)}}else{for(var c=0;c<j.length;c++){f.cancelUpload(j[c]);a("#"+j[c]).find(".data").removeClass("data");a("#"+j[c]).delay(1000+100*c).fadeOut(500,function(){a(this).remove()});this._trigger("onRemove",null);delete f.queueData.files[j[c]];h.reduece(j[c])}}}else{var m=a("#"+i);$item=a(m);f.cancelUpload($item.attr("id"));$item.find(".data").removeClass("data");$item.delay(1000).fadeOut(500,function(){a(this).remove()});this._trigger("onRemove",null);delete f.queueData.files[i];if(a("#"+i).hasClass("template-download")){f.reduceUploadCount();d=e.uploadedFileList;var l=this.getValues();d.splice(a.inArray(i,l),1)}else{if(a("#"+i).hasClass("template-upload")){b=e.unUploadedFileList;var l=this.getUnUploadValues();b.splice(a.inArray(i,l),1)}}}}},_destroy:function(){var c=this.element.data("swfuploader"),b=c.settings;c.destroy();this.element.find(".swfuploader").remove();if(b.uploadedFileList){a("#"+b.queueID).remove()}a("#"+b.id).replaceWith(this.element);if(b.onDestroy){b.onDestroy.call(this)}delete c},disable:function(b){var d=this.element.data("swfuploader"),c=d.settings;if(b){a("#"+this.options.queueID).addClass("coral-state-disabled");c.disabled=true;this._trigger("onDisable",null,[])}else{a("#"+this.options.queueID).removeClass("coral-state-disabled");c.disabled=false;this._trigger("onEnable",null,[])}d.setButtonDisabled(b)},getQueueData:function(){var f=[],d=[];
var e=this.element.data("swfuploader"),c=e.settings;for(var b=0;b<c.uploadedFileList.length;b++){f.push(c.uploadedFileList[b].fileId)}for(var b=0;b<c.unUploadedFileList.length;b++){d.push(c.unUploadedFileList[b].fileId)}return a.merge(f,d)},getUnUploadValues:function(){var b=[];var e=this.element.data("swfuploader"),d=e.settings;for(var c=0;c<d.unUploadedFileList.length;c++){b.push(d.unUploadedFileList[c].fileId)}return b},getValues:function(){var d=[];var e=this.element.data("swfuploader"),c=e.settings;for(var b=0;b<c.uploadedFileList.length;b++){d.push(c.uploadedFileList[b].fileId)}return d},getValue:function(){var c=this.element.data("swfuploader"),b=c.settings;return this.getValues().join(b.separator)},getValidateValue:function(){return this.getValue()},_setOption:function(c,g,h){var b=arguments;var e=g;var f=this.element.data("swfuploader"),d=f.settings;this._super(c,g);switch(c){case"uploader":f.setUploadURL(g);break;case"formData":if(!h){g=a.extend(d.formData,g)}f.setPostParams(d.formData);break;case"method":if(g=="get"){f.setUseQueryString(true)}else{f.setUseQueryString(false)}break;case"fileObjName":f.setFilePostName(g);break;case"fileTypeExts":f.setFileTypes(g,d.fileTypeDesc);break;case"fileTypeDesc":f.setFileTypes(d.fileTypeExts,g);break;case"maxFileSize":f.setFileSizeLimit(g);break;case"uploadLimit":f.setFileUploadLimit(g);break;case"queueSizeLimit":f.setFileQueueLimit(g);break;case"buttonCursor":if(g=="arrow"){f.setButtonCursor(SWFUpload.CURSOR.ARROW)}else{f.setButtonCursor(SWFUpload.CURSOR.HAND)}break;case"buttonText":a("#"+this.options.id+"-button").find(".swfuploader-button-text").html(g);break;case"width":f.setButtonDimensions(g,d.height);break;case"height":f.setButtonDimensions(d.width,g);break;case"multiple":if(g){f.setButtonAction(SWFUpload.BUTTON_ACTION.SELECT_FILES)}else{f.setButtonAction(SWFUpload.BUTTON_ACTION.SELECT_FILE)}break}},stop:function(){var b=this.element.data("swfuploader");b.queueData.averageSpeed=0;b.queueData.uploadSize=0;b.queueData.bytesUploaded=0;
b.queueData.uploadQueue=[];b.stopUpload();this._trigger("onStop",null,[])},upload:function(c){var d=arguments,g;var f=this.element.data("swfuploader"),e=f.settings;f.queueData.averageSpeed=0;f.queueData.uploadSize=0;f.queueData.bytesUploaded=0;f.queueData.uploadQueue=[];if(!e.disabled){if(d[0]||typeof c==="undefined"){if(typeof c==="undefined"){f.queueData.uploadSize=f.queueData.queueSize;var b=e.unUploadedFileList;f.queueData.uploadQueue.push("*");f.startUpload()}else{for(g=0;g<d.length;g++){f.queueData.uploadQueue.push(d[g])}f.startUpload(f.queueData.uploadQueue.shift())}}else{f.startUpload()}}},onDialogOpen:function(){var b=this.settings;this.queueData.errorMsg="Some files were not added to the queue:";this.queueData.filesReplaced=0;this.queueData.filesCancelled=0;if(b.onDialogOpen){b.onDialogOpen.call(this)}},onDialogClose:function(b,d,e){var c=this.settings;this.queueData.filesErrored=b-d;this.queueData.filesSelected=b;this.queueData.filesQueued=d-this.queueData.filesCancelled;this.queueData.queueLength=e;if(a.inArray("onDialogClose",c.overrideEvents)<0){if(this.queueData.filesErrored>0){}}if(c.onDialogClose){c.onDialogClose.call(this,this.queueData)}if(c.auto){a("#"+c.id).swfuploader("upload","*")}},handerSWFEvent:function(){},validateFiles:function(b,c){var d=b.settings;if(d.acceptFileTypes&&!(d.acceptFileTypes.test(c.type)||d.acceptFileTypes.test(c.name))){c.error="The file is not an accepted file type."}else{if(c.size>d.maxFileSize){c.error="The File is too large."}}return c.error},onSelect:function(j,c){var e=j.settings,l,m;var b={};var f=Math.round(c.size/1024);var k="KB";if(f>1000){f=Math.round(f/1000);k="MB"}var h=f.toString().split(".");f=h[0];if(h.length>1){f+="."+h[1].substr(0,2)}f+=k;var g=c.name;if(g.length>25){g=g.substr(0,25)+"..."}itemData={fileID:c.id,instanceID:e.id,fileName:g,fileSize:f};if(a.inArray("onSelect",e.overrideEvents)<0){l=e.uploadTemplate({files:[c],options:e});for(var i in itemData){l=l.replace(new RegExp("\\$\\{"+i+"\\}","g"),itemData[i])
}l=a(e.templatesContainer).html(l).children();l.addClass("template-upload fade");a("#"+e.queueID).append(l);this._trigger("onRenderUploadTmp",null,{item:l})}j.queueData.queueSize+=c.size;j.queueData.files[c.id]=c;this._trigger("onSelect",null,[{file:c}])},onSelectError:function(c,d,h,g){var e=c.settings,b,f;if(a.inArray("onSelectError",e.overrideEvents)<0){switch(h){case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:if(e.queueSizeLimit>g){alert("\nThe number of files selected exceeds the remaining upload limit")}else{alert("\nThe number of files selected exceeds the queue size limit")}break;case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:a.messageQueue({message:"The File is too large"});break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:c.queueData.errorMsg='\nThe file "'+d.name+'" is empty.';break;case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:c.queueData.errorMsg='\nThe file "'+d.name+'" is not an accepted file type ('+e.fileTypeDesc+").";break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:a.messageQueue({message:"The file is not an accepted file type"});break}}if(h!=SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED){delete c.queueData.files[d.id]}this._trigger("onSelectError",null,[{file:d,error:g}])},onQueueComplete:function(){if(this.settings.onQueueComplete){this.settings.onQueueComplete.call(this,this.settings.queueData)}},onUploadComplete:function(c,f){var g=c.settings,h=c;var e=c.getStats();c.queueData.queueLength=e.files_queued;if(c.queueData.uploadQueue[0]=="*"){if(c.queueData.queueLength>0){c.startUpload()}else{c.queueData.uploadQueue=[];if(g.onQueueComplete){g.onQueueComplete.call(c,c.queueData)}}}else{if(c.queueData.uploadQueue.length>0){c.startUpload(c.queueData.uploadQueue.shift())}else{c.queueData.uploadQueue=[];if(g.onQueueComplete){g.onQueueComplete.call(c,c.queueData)}}}if(a.inArray("onUploadComplete",g.overrideEvents)<0){if(g.removeCompleted){switch(f.filestatus){case SWFUpload.FILE_STATUS.COMPLETE:setTimeout(function(){if(a("#"+f.id)){h.queueData.queueSize-=f.size;
h.queueData.queueLength-=1;delete h.queueData.files[f.id];a("#"+f.id).fadeOut(500,function(){a(this).remove()})}},g.removeTimeout*1000);break;case SWFUpload.FILE_STATUS.ERROR:if(!g.requeueErrors){setTimeout(function(){if(a("#"+f.id)){h.queueData.queueSize-=f.size;h.queueData.queueLength-=1;delete h.queueData.files[f.id];a("#"+f.id).fadeOut(500,function(){a(this).remove()})}},g.removeTimeout*1000)}break}}else{f.uploaded=true}}var d=g.unUploadedFileList;var b=this.getUnUploadValues();d.splice(a.inArray(f[g.prmNames.fileId],b),1);this._trigger("onComplete",null,[{file:f}])},onUploadError:function(b,d,h,g){var e=b.settings;var f="Error";switch(h){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:f="HTTP Error ("+g+")";this._trigger("onFail",null,[{file:d,error:g}]);break;case SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL:f="Missing Upload URL";break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:f="IO Error";this._trigger("onFail",null,[{file:d,error:g}]);break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:f="Security Error";this._trigger("onFail",null,[{file:d,error:g}]);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:alert("The upload limit has been reached ("+g+").");f="Exceeds Upload Limit";break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:f="Failed";this._trigger("onFail",null,[{file:d,error:g}]);break;case SWFUpload.UPLOAD_ERROR.SPECIFIED_FILE_ID_NOT_FOUND:break;case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:f="Validation Error";break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:f="Cancelled";b.queueData.queueSize-=d.size;b.queueData.queueLength-=1;if(d.status==SWFUpload.FILE_STATUS.IN_PROGRESS||a.inArray(d.id,b.queueData.uploadQueue)>=0){b.queueData.uploadSize-=d.size}delete b.queueData.files[d.id];break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:f="Stopped";this._trigger("onFail",null,[{file:d,error:g}]);break}if(a.inArray("onUploadError",e.overrideEvents)<0){}var c=b.getStats();b.queueData.uploadsErrored=c.upload_errors},onUploadProgress:function(m,f,l,i){var g=m.settings;var d=new Date();
var n=d.getTime();var j=n-m.timer;if(j>500){m.timer=n}var h=l-m.bytesLoaded;m.bytesLoaded=l;var c=m.queueData.queueBytesUploaded+l;var b=Math.round(l/i*100);var o="KB/s";var k=0;var e=(h/1024)/(j/1000);e=Math.floor(e*10)/10;if(m.queueData.averageSpeed>0){m.queueData.averageSpeed=Math.floor((m.queueData.averageSpeed+e)/2)}else{m.queueData.averageSpeed=Math.floor(e)}if(e>1000){k=(e*0.001);m.queueData.averageSpeed=Math.floor(k);o="MB/s"}if(a.inArray("onUploadProgress",g.overrideEvents)<0){a("#"+f.id).find(".progressbar-value").show().css("width",b+"%");a("#"+f.id).find(".progressbar-text").text(b+"%")}this._trigger("onProgress",null,[{file:f}])},onUploadStart:function(b,c){var d=b.settings;var e=new Date();b.timer=e.getTime();b.bytesLoaded=0;if(b.queueData.uploadQueue.length==0){b.queueData.uploadSize=c.size}if(d.checkExisting){a.ajax({type:"POST",async:false,url:d.checkExisting,data:{filename:c.name},success:function(g){if(g==1){var f=confirm('A file with the name "'+c.name+'" already exists on the server.\nWould you like to replace the existing file?');if(!f){b.cancelUpload(c.id);a("#"+c.id).remove();if(b.queueData.uploadQueue.length>0&&b.queueData.queueLength>0){if(b.queueData.uploadQueue[0]=="*"){b.startUpload()}else{b.startUpload(b.queueData.uploadQueue.shift())}}}}}})}this._trigger("onStart",null,[{file:c}]);this._trigger("onSend",null,[{file:c}])},onUploadSuccess:function(l,b,h,f){var c=l.settings,n;var i=l.getStats();l.queueData.uploadsSuccessful=i.successful_uploads;l.queueData.queueBytesUploaded+=b.size;if(a.inArray("onUploadSuccess",c.overrideEvents)<0){a("#"+b.id).find(".data").html(" - 上传完成")}var e=Math.round(b.size/1024);var m="KB";if(e>1000){e=Math.round(e/1000);m="MB"}var j=e.toString().split(".");e=j[0];if(j.length>1){e+="."+j[1].substr(0,2)}e+=m;var g=b.name;if(g.length>25){g=g.substr(0,25)+"..."}if(a.inArray("onSelect",c.overrideEvents)<0){n=c.downloadTemplate({files:[b],options:c});for(var k in itemData){n=n.replace(new RegExp("\\$\\{"+k+"\\}","g"),itemData[k])
}if(c.uploadTemplate){n=a(c.templatesContainer).html(n).children();n.addClass("template-download fade");a("#"+b.id).replaceWith(n)}this._trigger("onRenderDownloadTmp",null,{item:n})}this._trigger("onSuccess",null,[{file:b}])}})})($);