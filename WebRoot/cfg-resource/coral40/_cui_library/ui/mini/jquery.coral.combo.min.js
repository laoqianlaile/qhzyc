/*!
 * 组件库4.0：下拉框
 * 
 * 依赖JS文件：
 *    jquery.coral.core.js
 *    jquery.coral.component.js
 *    jquery.coral.panel.js
 *    jquery.validatehelper.js
 *    jquery.coral.control.js
 */
(function(a){a(document).unbind(".coral-combobox").bind("mousedown.coral-combobox mousewheel.coral-combobox",function(g){var f=a(g.target).closest(".coral-combo-panel").length;var h=a(g.target).closest(".coral-combo").length;var d=a(g.target).closest(".coral-button").length;if(f||(h&&!d)){return}b()});function b(c,d){a(".coral-combo-wrapper").not(c).hide();a(".coral-combo-iframePanel:visible").not(d).hide()}a.component("coral.combo",a.coral.control,{castProperties:["triggers"],version:"4.0.2",options:{panelRenderOnShow:false,popupDialog:false,showStar:true,showDirection:null,labelField:null,starBefore:false,isInited:false,id:null,name:null,showOnFocus:true,iframePanel:false,buttons:[],forceSelection:true,width:"auto",height:22,placeholder:"",cls:"",required:false,errMsg:null,errMsgPosition:"leftBottom",isLabel:false,panelWidth:null,panelHeight:"auto",position:{my:"left top",at:"left bottom",collision:"none"},maxPanelHeight:200,multiple:false,separator:",",valueTextSeparator:"-",postMode:"value",editable:false,readonly:false,readonlyInput:true,disabled:false,hasDownArrow:true,value:null,delay:200,zIndex:10000,enableHighlight:false,enablePinyin:false,showClose:false,enableFilter:false,enterFilter:true,query:null,filter:function(h,j){var e=a(this).attr("component-role"),f=a(this)[e]("option"),c=f.textField,d=f.valueField,i=(j[c]).toLowerCase(),g=(j[d]).toString().toLowerCase();h=h.toLowerCase();if(i.indexOf(h)>-1){return"text"}if(f.enablePinyin===true){if(pinyinEngine.toPinyin(i,false,"").indexOf(h)>-1){return true}}if(g.indexOf(h)>-1){return true}else{return false}},onKeyUp:null,onKeyDown:null,onEnter:null,onBlur:null,onClick:null,onValidError:null,onValidSuccess:null,onShowPanel:a.noop,onHidePanel:a.noop,onChange:a.noop,triggers:null,excluded:false},_addCacheItem:function(c){if(typeof c!=="object"){return
}if(typeof this.cache==="undefined"){this.cache={}}this.cache=a.extend({},this.cache,c)},_getCacheItem:function(c){if(typeof c!=="string"){return}if(this.cache&&this.cache[c]){return this.cache[c]}else{return null}},_removeCacheItem:function(c){if(this.cache&&this.cache[c]){delete this.cache[c]}},_create:function(){this._prepareInit();this._initCombo();this._initState();this._initData();this._bindEvent();this._setDefaultValue()},_prepareInit:function(){this.panelRendered=false;this.dataLoaded=false;if(this.options.enableSearch===true){this.options.readonlyInput=false}if(this.options.popupDialog||this.options.enableFilter){this.options.readonlyInput=true}this.element.hide();if(this.element.attr("id")){if(this.element.attr("id")!=this.options.id){this.options.id=this.element.attr("id")}}else{if(this.options.id){this.element.attr("id",this.options.id)}}if(!this.element.attr("id")){this.options.id=this.element.uniqueId().attr("id")}if(this.element.attr("name")&&this.options.name){if(this.element.attr("name")!=this.options.name){this.options.name=this.element.attr("name")}}else{if(!this.options.name&&this.element.attr("name")){this.options.name=this.element.attr("name")}}},_initCombo:function(){var e=null,d=null,g="",c="";this.uiCombo={combo:null,panel:null};this.previousValue=null;this.uiCombo.combo=a("<span class='coral-combo coral-textbox'></span>").insertAfter(this.element);this.element.appendTo(this.uiCombo.combo);if(this.options.hasDownArrow){c="<span class='coral-combo-arrow coral-icon-arrow icon icon-arrow-down2'></span>"}if(this.options.showClose&&!this.options.required){g="<span class='coral-combo-close icon icon-close2'></span>"}this.elementBorder=a("<span class='coral-combo-border coral-textbox-border coral-corner-all'>"+g+c+"</span>").appendTo(this.uiCombo.combo);if(this.options.labelField){this.uiLabel=a('<label class="coral-label">'+this.options.labelField+"</label>");this.elementBorder.before(this.uiLabel);this.uiCombo.combo.addClass("coral-hasLabel")}this.uiCombo.textbox=a("<input type='text' autocomplete='off' class='coral-combo-text coral-combo-default coral-textbox-default'>").appendTo(this.elementBorder);
var f="";if(this.options.name){this.element.removeAttr("name").attr("orgname",this.options.name);f=" name='"+this.options.name+"'"}d=a("<input type='hidden' "+f+" class='coral-combo-value'>").appendTo(this.uiCombo.combo);this.uiCombo.panel=a("<div class='coral-combo-panel'></div>").appendTo("body");if(this.options.iframePanel){this.uiCombo.iframePanel=a("<iframe class='coral-combo-iframePanel' style='position:absolute;display:none;'></iframe>").appendTo("body")}this.uiCombo.pContent=a("<div class='coral-combo-content'></div>").appendTo(this.uiCombo.panel);if(this.options.enableFilter){a("<div class='coral-combo-filter'><span class='coral-combo-filter-border'><input type='text' class='coral-combo-filterbox'></span><span class='coral-combo-search icon icon-search3'></span></div>").appendTo(this.uiCombo.panel)}var h="absolute";if(this.options.popupDialog){h="";this.uiCombo.popupDialog=a("<div class='coral-combo-popup-dialog'></div>").appendTo("body");this.uiCombo.popupInputbox=a("<input type='text' />").appendTo(this.uiCombo.popupDialog)}this.uiCombo.panel.css({position:h}).addClass("coral-combo-wrapper "+this.options.cls+"-panel coral-front").hide();this.uiCombo.textbox.attr("placeholder",this.options.placeholder);this._showPlaceholder();if(this.options.buttons.length>0){this._createButtonPanel()}},_initState:function(){this.options.isLabel===true?this._setIsLabel(this.options.isLabel):this._setReadonly(this.options.readonly);if(!this.options.readonly){this.uiCombo.textbox.prop("readonly",this.options.readonlyInput)}this._setDisabled(this.options.disabled);this.resize()},_initData:a.noop,_setDefaultValue:function(){if(!this.options.value){return}var c=this.options.onChange;this.options.onChange=a.noop;if(this.options.multiple){if(null!==this.options.value){if(typeof this.options.value=="object"){this.setValues(this.options.value)}else{this.setValues([this.options.value])}}this.options.originalValue=this.getValues()}else{this.setValues([this.options.value]);this.options.originalValue=this.options.value
}this.options.onChange=c},_showPlaceholder:function(d){if(a.support.placeholder||this.component().find(".coral-textbox-placeholder-label").length){return}d=d?d:this.options.placeholder;var c=a("<span class='coral-textbox-placeholder-label'>"+d+"</span>");a(this.uiCombo.textbox).after(c)},_hidePlaceholder:function(){if(a.support.placeholder){return}var c=this;c.component().find(".coral-textbox-placeholder-label").remove()},_setIsLabel:function(c){var d=this;if(true===c){this.component().removeClass("coral-readonly");this.component().addClass("coral-isLabel");this.uiCombo.textbox.prop("readonly",true);if(this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}this.hidePanel()}else{this.component().removeClass("coral-isLabel coral-readonly");this.uiCombo.textbox.prop("readonly",this.options.readonlyInput);this.options.readonly=false}this.options.isLabel=!!c},_setReadonly:function(c){if(c){this.element.prop("readonly",true);this.uiCombo.textbox.prop("readonly",true);this.uiCombo.combo.find(".coral-combo-value").prop("readonly",true)}else{a(this.element).prop("readonly",false);this.uiCombo.textbox.prop("readonly",false);this.uiCombo.combo.find(".coral-combo-value").prop("readonly",false)}this.options.readonly=!!c;this.uiCombo.combo.removeClass("coral-isLabel");this.uiCombo.combo.toggleClass("coral-readonly",this.options.readonly)},_setDisabled:function(c){if(c){this.element.prop("disabled",true);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",true);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",true)}else{a(this.element).prop("disabled",false);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",false);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",false)}this.options.disabled=!!c;this.uiCombo.combo.toggleClass(this.componentFullName+"-disabled coral-state-disabled",this.options.disabled)},_selectPrev:a.noop,_selectNext:a.noop,_doEnter:a.noop,_doQuery:a.noop,_addHighlight:function(d,c){if(c===""||!d.length||!this.options.enableHighlight){return
}d=a(d);var f="",g=c.replace(/[\s]+/g," ").split(" "),e;d.each(function(i,k){var h=a(k),l=a(k).parent(),j=a(k).html();if(j==c){return}if(h.hasClass(".coral-combobox-item-selected")){l.html(that._getTextFromHTML(j));return}if(!h.children("input").length){for(var m=0;m<g.length;m++){e=new RegExp(""+g[m]+"","gmi");j=j.replace(e,'<span class="coral-keyword-highlight">'+g[m]+"</span>")}h.html(j)}})},_getTextFromHTML:function(c){if(typeof c==="undefined"){return}c=c.replace(/<\/?[^>]*>/g,"");c=c.replace(/[ | ]*\n/g,"\n");c=c.replace(/&nbsp;/ig,"");return c},_removeHighlight:function(c){if(!c.length||!this.options.enableHighlight){return}c=a(c);var d=this;c.each(function(e,g){var h=a(g).parent();var f=h.html();h.html(d._getTextFromHTML(f))})},focus:function(){var d=this;if(this.options.disabled||this.options.readonly||this.options.isLabel){return false}this.uiCombo.textbox.focus();if(!this.isLoaded){var c={focus:{param:null}};this._addCacheItem(c);return true}return true},_bindEvent:function(){var h=this,c=this.options,e=this.uiCombo.combo,d=this.uiCombo.panel,f=this.uiCombo.iframePanel;if(this.options.disabled){this.element.addClass("coral-state-disabled")}this._off(h.component());var k,j;this._on({"mouseenter.coral-combo-border":function(l){if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){return}h.uiCombo.combo.addClass("coral-textbox-hover")},"mouseleave.coral-combo-border":function(l){if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){return}h.uiCombo.combo.removeClass("coral-textbox-hover")},"keydown.coral-combo-text":function(o){this.previousValue=a(o.target).val();if(this.options.readonly||this.options.isLabel){return}var l=this.panel(),m=l.find(".coral-combobox-item");var n=a.coral.keyCode;switch(o.keyCode){case n.TAB:break;case n.ENTER:o.preventDefault();this._doEnter(o);this._trigger("onEnter",o,{});break;case n.ESCAPE:this.hidePanel();break;case n.UP:o.preventDefault();if(this.options.readonly===false){if(!l.is(":visible")){h.showPanel()
}else{if(c.onSelectPrev){h._trigger("onSelectPrev",o)}else{h._selectPrev(o)}}}break;case n.DOWN:o.preventDefault();if(this.options.readonly===false){if(!l.is(":visible")){this.showPanel()}else{if(c.onSelectNext){this._trigger("onSelectNext",o)}else{this._selectNext(o)}}}break;default:this._filter(o);break}this._hidePlaceholder();this._trigger("onKeyDown",o)},"keyup.coral-combo-text":function(l){if(this.options.readonly||this.options.isLabel){return}this._trigger("onKeyUp",l,{})},"blur.coral-combo-text":function(q){var p=a(q.target),r=[],o=p.val();if(this.options.multiple){o=o.split(this.options.separator)}else{o=[o]}this._showItems();if(o.toString()!=this.previousValue){var n=this.options.textField,m=this.options.valueField;var l=this._checkMathch(o,true);if(!l){p.val("");this.setValues([""])}else{this.setValues(l.valarr)}}},"focusin.coral-combo-text":function(l){if(this.options.readonly||this.options.isLabel){return}this.component().addClass("coral-state-focus");if(!k){this._trigger("onFocus",l)}},"focusout.coral-combo-text":function(l){if(this.options.readonly||this.options.isLabel){return}this._delay(function(){if(k){k=false;return}this.component().removeClass("coral-state-focus");if(j){j=false;return}this.hidePanel();this._trigger("onBlur",l)},100)},"click.coral-combo-text":function(l){if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")||!h.options.readonlyInput){return}if(h.component().hasClass("coral-state-focus")){if(this.options.popupDialog&&this.options.showOnFocus===true){this.uiCombo.popupDialog.dialog("open")}else{if(d.is(":visible")){this.hidePanel()}else{this.showPanel()}}}if(this.options.enableFilter){j=true}h._trigger("onClick",l)},"mousedown.coral-combo-arrow":function(l){if(this.component().hasClass("coral-isLabel")||this.component().hasClass("coral-readonly")){return}if(this.component().hasClass("coral-state-focus")){k=true}},"click.coral-combo-arrow":function(l){b(d,f);if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){return
}if(h.component().hasClass("coral-state-focus")){k=true}if(this.options.enableFilter){j=true}this.focus();if(h.options.popupDialog){h.showPanel();h.uiCombo.popupDialog.dialog("open")}else{if(d.is(":visible")){h.hidePanel()}else{h.showPanel()}}},"click.coral-combo-close":function(l){if(this.component().hasClass("coral-state-focus")){k=true}this.clear();if(this.options.placeholder){this._showPlaceholder()}},combogridonshowpanel:function(l){h._removeGridHighlights();h._scrollTo(h.getValue());h.grid().grid("refresh")}});if(h.options.enableFilter){var g=this.uiCombo.panel.find(".coral-combo-filterbox"),i=this.uiCombo.panel.find(".coral-combo-search");g.bind({focusout:function(l){},keyup:function(l){if(!h.options.enterFilter){return}h._filter(l,true)}});i.bind({click:function(l){l.preventDefault();h._filter(l,true);return false}})}},_searchFilter:a.noop,_filter:function(h,d){var g=this,f=this.options,c=this.panel();if(g.timer){clearTimeout(g.timer)}if(!c.is(":visible")){g.showPanel()}g.timer=setTimeout(function(){var k=a(h.target).val();if(d){k=c.find(".coral-combo-filterbox").val()}if(g.options.multiple){k=k.split(f.separator)}else{k=[k]}if(f.query){f.query.call(g.element,k)}else{g._doQuery(k)}var j=g.options.textField,i=g.options.valueField;if(!d){var e=g._checkMathch(k,false);g.setValues(e.valarr,true,false)}g.resizeIframePanel()},f.delay);return false},_formatValue:function(c){return c},_setOption:function(c,d){if(c==="id"||c==="name"){return}if(c==="readonly"){this._setReadonly(d)}if(c==="disabled"){this._setDisabled(d)}this._super(c,d);if(c==="isLabel"){this._setIsLabel(d);return}},_destroy:function(){this.panel().remove();if(this.options.iframePanel){this.uiCombo.iframePanel.remove()}this.component().replaceWith(this.element);if(this.options.name){this.element.removeAttr("orgname").attr("name",this.options.name)}this.element.show()},component:function(){return this.uiCombo.combo},panel:function(){return this.uiCombo.panel},uiArrow:function(){return this.uiCombo.combo.find("span.coral-combo-arrow")
},uiClose:function(){return this.uiCombo.combo.find("span.coral-combo-close")},uiBorder:function(){return this.component().find("span.coral-combo-border")},resize:function(g){var h=this.options,i=this.uiCombo.combo,e=this.uiCombo.panel,d=this.elementBorder;if(g){h.width=g}if(h.width=="auto"){return}if(isNaN(h.width)){var f=this.element.parent(":first"),c=null;g=this.element.outerWidth();if(f&&f.get(0).tagName!=="BODY"){c=f.outerWidth();if(c<g){g=c}}h.width=g}i.outerWidth(h.width)},resizeIframePanel:function(){var e=this.options,c,g=this.uiCombo.combo,d=this.uiCombo.panel,f=this.uiCombo.iframePanel||a();c=d.height();f.css("height",c)},_initPanel:function(){var f=this.options,g=this.uiCombo.combo,d=this.elementBorder,c=this.uiCombo.panel,e=f.panelHeight;if(!this.panelRendered){this._renderItems(this.options.data);this.uiCombo.pContent.html(this.lazyPanelHtml);this.panelRendered=true;this.lazyPanelHtml=""}c.css("width",(f.panelWidth?f.panelWidth:d.outerWidth()));c.css("height",e);if(isNaN(e)){this.uiCombo.pContent.css({"max-height":f.maxPanelHeight+"px"});this.uiCombo.popupDialogTree&&this.uiCombo.popupDialogTree.css({"max-height":f.maxPanelHeight+"px"})}if(this.options.enableFilter&&!isNaN(e)){this.uiCombo.pContent.height(f.panelHeight-30)}else{if(e=="auto"){this.uiCombo.pContent.height("")}else{this.uiCombo.pContent.height(e-2)}}if(this.options.iframePanel){this.uiCombo.iframePanel.css("height",c.outerHeight())}},showPanel:function(){var h=this,c=this.options,e=this.uiCombo.combo,g=this.elementBorder,k=this.options.showDirection,d=this.uiCombo.panel,f=this.uiCombo.iframePanel||a();if(d.is(":hidden")){var j=a(".coral-front:visible").map(function(){return +a(this).css("z-index")}).get(),i=Math.max.apply(null,j);if(i>=+d.css("z-index")){d.css("z-index",i+1);if(this.options.iframePanel){f.css("z-index",i)}}if(!this._PanelInited){this._initPanel()}this._PanelInited=true;d.show(0,function(){h._trigger("onShowPanel",null,{});f.show();(function l(){if(d.is(":visible")){d.css({left:a.coral.getLeft(d,g),top:a.coral.getTop(d,g,k),width:(c.panelWidth?c.panelWidth:g.outerWidth())});
if(h.options.iframePanel){f.css({left:a.coral.getLeft(f,g),top:a.coral.getTop(f,e,k),width:(c.panelWidth?c.panelWidth:g.outerWidth())})}setTimeout(l,200)}})();h.uiCombo.panel.find(".coral-combo-filterbox").focus()})}if(c.enableFilter){this.setValues(this.getValues())}},hidePanel:function(){this.uiCombo.panel.hide();if(this.uiCombo.iframePanel){this.uiCombo.iframePanel.hide()}this._trigger("onHidePanel",null,{})},disable:function(){this._setDisabled(true)},enable:function(){this._setDisabled(false)},show:function(){this._super()},hide:function(){this._super();this.hidePanel()},hideErrors:function(){a.validate.hideErrors(this.uiBorder());this.component().removeClass("coral-combo-error")},clear:function(){var d=this.uiCombo.combo.find("input.coral-combo-value"),c=this.uiCombo.combo.find("input.coral-combo-text");this.currentValues=[];this.setValues([""],false,true)},getOldText:function(){return this.oldText},reset:function(){if(this.options.multiple){this.setValues(this.options.originalValue)}else{this.setValue(this.options.originalValue)}},getText:function(){return this.uiCombo.combo.find("input.coral-combo-text").val()},_setText:function(c){var d=this.uiCombo.combo.find("input.coral-combo-text");d.val(c);this.previousValue=c},setText:function(c){this._setText(c)},getValues:function(){var c=[];this.uiCombo.combo.find("input.coral-combo-value").each(function(){c.push(a(this).val())});return c},setValues:function(o,l,k){var p=this.getValues(),m=null,g=0,c=[],e=[];o=o||[];this.oldValues=p;var h=[],d="",n="";this.uiCombo.combo.find("input.coral-combo-value").remove();for(g=0;g<o.length;g++){d="";n="";if(this.options.name){d=" name='"+this.options.name+"' "}h.push("<input type='hidden' "+d+" value='"+this._formatValue(o[g])+"' class='coral-combo-value' />")}this.uiCombo.combo.append(h.join(""));for(g=0;g<p.length;g++){c[g]=p[g]}for(g=0;g<o.length;g++){for(var f=0;f<c.length;f++){if(o[g]==c[f]){e.push(o[g]);c.splice(f,1);break}}}if(o.length){if(this.options.placeholder){this._hidePlaceholder()
}}if((e.length!=o.length||o.length!=p.length)&&(!l)&&k){if(this.options.multiple){this._trigger("onChange",null,{value:o,newValue:o,newText:this.getText(),text:this.getText(),oldValue:p,oldText:this.getOldText()})}else{this._trigger("onChange",null,{value:o[0],newValue:o[0],newText:this.getText(),text:this.getText(),oldValue:p[0],oldText:this.getOldText()})}}},getValue:function(){return this.getValues().join(this.options.separator)},setValue:function(c){c=c.split(this.options.separator);this.setValues(c)},getSelectedItems:function(){var f=this.getValues(),k=[];var d=this.options.data;for(var e=0;e<f.length;e++){for(var c=0;c<d.length;c++){var h=d[c];if(f[e]==h.id){for(var g in h){k.push(g+"="+h[g]+"\n")}}}}return k},refresh:function(){this.destroy();this.component().remove();this._create()}})})(jQuery);