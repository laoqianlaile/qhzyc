(function(a){if(typeof define==="function"&&define.amd){define(["jquery","tmpl","./jquery.fileupload-image","./jquery.fileupload-audio","./jquery.fileupload-video","./jquery.fileupload-validate"],a)}else{if(typeof exports==="object"){a(require("jquery"),require("tmpl"))}else{a(window.jQuery,window.tmpl)}}}(function(b,a){b.blueimp.fileupload.prototype._specialOptions.push("filesContainer","uploadTemplateId","downloadTemplateId");b.component("blueimp.fileupload",b.blueimp.fileupload,{getUnUploadValues:function(){var c=[];for(var d=0;d<this.options.unUploadedFileList.length;d++){c.push(this.options.unUploadedFileList[d][this.options.prmNames.fileId])}return c},remove:function(e){var f=this;function c(h){var g=b("#"+h).data("data");if(b("#"+h).hasClass("template-download")){f._trigger("remove",null,b.extend({context:b("#"+h),type:"DELETE"},g))}else{if(b("#"+h).hasClass("template-upload")){if(g.abort){g.abort()}else{g.errorThrown="abort";f._trigger("fail",null,b.extend({context:b("#"+h),type:"DELETE"},g))}}}}if(e===undefined){this.options.filesContainer.children().each(function(){c(this.id)})}else{if(typeof e==="array"){for(var d=0;d<e.length;d++){c(e[d])}}else{c(e)}}this._trigger("onDelete",null)},destroy:function(){this.element.find(".fileupload-buttonbar").find(".fileinput-button").each(function(){var c=b(this).find("input:file").detach();b(this).button("destroy").append(c)});this.element.find(".ctrl-init-button").remove();this.options.filesContainer.remove();this._super()},upload:function(d){if(b.isArray(d)){for(var c=0;c<d.length;c++){var e=b("#"+d[c]).data("data");if(e&&e.submit){e.submit()}}}else{var e=b("#"+d).data("data");if(e&&e.submit){e.submit()}}}});b.component("coral.fileuploader",{castProperties:["triggers"],checkIE:function(){var c=3,e=document.createElement("div"),d=e.getElementsByTagName("i");while(e.innerHTML="<!--[if gt IE "+(++c)+"]><i></i><![endif]-->",d[0]){}return c>4?c:false},options:{prmNames:{fileName:"name",fileSize:"size",fileURL:"url",fileError:"error",fileId:"id",filetype:"type"},focus:null,clearError:null,triggers:null,postData:{},autoUpload:false,removeCompleted:false,maxFileSize:"5012kb",separator:",",filesUrl:null,filesLimt:9999,multiple:"multiple",uploadBtnOptions:{icons:"",label:"+"}},_getConfig:function(){var f,i=this;
var d=this.checkIE();var e=this.options;if(!e.queueID){e.queueID=this.element[0].id+"_queueID";e.filesContainer=b("<ul/>",{"class":"files",id:e.queueID});this.element.before(e.filesContainer)}else{e.filesContainer=b("#"+e.queueID)}if(e.queueMode=="list"){e.filesContainer.addClass("list-files")}if(e.queueMode=="card"){e.filesContainer.addClass("card-files")}if(e.queueMode!=="card"&&e.queueMode!=="list"){e.filesContainer.addClass(e.queueMode)}e.templatesContainer=this.document[0].createElement(e.filesContainer.prop("nodeName"));e.uploadTmp=function(l){var j,k;if(l.fileError){j='<div class="fileError"><span class="error"></span></div>'}else{j=""}k='<li id="${fileId}" class="fileItem"><div class="fileContent"><span class="fileThumb">${fileType}</span><div class="progress"><div class="progressbar-value"></div></div><span class="fileName" title="${fileName}">${fileName}</span><span class="fileSize">(${fileSize})k</span><span class="fileAction"><span class="progressbar-text"></span><span class="upload cui-icon-plus-circle2"></span><span class="remove cui-icon-minus-circle2"></span></span>'+j+"</div></li>";return k};e.uploadTemplate=function(r){var m="fileId_"+new Date().getTime();var l=r.options.prmNames;r.options.unUploadedFileList=r.options.unUploadedFileList||[];var p=r.options.autoUpload,k,n,j={fileName:r.files[0][l.fileName],fileSize:r.files[0][l.fileSize],fileId:r.files[0][l.fileId]||m,fileError:r.files[0][l.fileError],fileType:r.files[0][l.filetype]};r.files[0].id=j.fileId;j.fileType=j.fileName.substring(j.fileName.lastIndexOf(".")+1);r.options.unUploadedFileList.push(j);if(!p){k="disabled"}n=r.options.uploadTmp(j);for(var q in j){n=n.replace(new RegExp("\\$\\{"+q+"\\}","g"),j[q])}return n};e.downloadTmp=function(l){var j,k;if(l.fileError){j='<div class="fileError"><span class="error"></span>${fileError}</div>'}else{j=""}k='<li id="${fileId}" class="fileItem"><div class="fileContent"><span class="fileThumb">${fileType}</span><div class="progress"><div class="progressbar-value"></div></div><span class="fileName"><a href="${fileUrl} title="${fileName} download=${fileName}">${fileName}</a></span><span class="fileSize">(${fileSize})k</span><span class="remove cui-icon-minus-circle2 fileAction"></span></span>'+j+"</div></li>";
return k};e.downloadTemplate=function(j){var s=j.options.prmNames;j.options.uploadedFileList=j.options.uploadedFileList||[];var k="fileId_"+new Date().getTime();var q=j.options.autoUpload,m,r,p,l={fileName:j.files[0][s.fileName],fileSize:j.files[0][s.fileSize],fileUrl:j.options[s.fileUrl],fileError:j.files[0][s.fileError],fileId:j.files[0][s.fileId]||k,fileType:j.files[0][s.filetype]};j.options.uploadedFileList.push(l);r=j.options.downloadTmp(l);for(var n in l){r=r.replace(new RegExp("\\$\\{"+n+"\\}","g"),l[n])}return r};this.useFlash=(d!==false&&d<10);if(this.options.uploadBtn){var h="fileinput-button",g=this.options.uploadBtnOptions;if(g.cls){g=b.extend({},g,{cls:h+" "+g.cls})}else{g=b.extend({},g,{cls:h})}b(this.options.uploadBtn).button(g);var c={type:"file",name:"uploadFile"};if(this.options.multiple){c.multiple="mutiple"}b("<input/>",c).appendTo(b(this.options.uploadBtn));this.uploadFile=b(this.options.uploadBtn).find("input[type=file]");this.uploaderBtn=b(this.options.uploadBtn).uniqueId()}else{this.uploadFile=this.element.find("input[type=file]");this.uploaderBtn=this.element.find(".fileinput-button").uniqueId()}if(this.useFlash){this.uploadFile.hide();f={swf:b.coral.scriptPath+"external/swfupload.swf",uploader:this.options.url,auto:this.options.autoUpload,separator:this.options.separator,checkExisting:false,debug:this.options.debug,fileObjName:"uploadFile",height:130,uploadTemplate:this.options.uploadTemplate,downloadTemplate:this.options.downloadTemplate,method:"post",multi:this.options.multi,formData:this.options.formData,preventCaching:true,progressData:"percentage",queueID:this.options.queueID,queueSizeLimit:999,removeCompleted:this.options.removeCompleted,removeTimeout:this.options.removeTimeout,requeueErrors:false,successTimeout:30,uploadLimit:this.options.filesLimt,width:820,maxFileSize:this.options.maxFileSize,fileTypeExts:this.options.acceptFileTypes,onSWFReady:function(){if(i.options.filesUrl){b.ajax({type:"POST",async:false,datatype:"json",url:i.options.filesUrl,data:i.options.postData,success:function(l){for(var j=0;
j<l.length;j++){var k=i._renderDownload([l[j]]).appendTo(i.options.filesContainer);i._transition(k);i.uploaderBtn.swfuploader("addUploadCount")}},error:function(j){}})}},overrideEvents:[]};b.extend(true,f,this.options);this.uploaderBtn.swfuploader(f)}else{f={disabled:false,autoUpload:false,url:this.options.url,maxFileSize:this.options.maxFileSize,maxNumberOfFiles:this.options.maxNumberOfFiles,acceptFileTypes:this.options.acceptFileTypes,uploadTemplate:this.options.uploadTemplate,downloadTemplate:this.options.downloadTemplate,templatesContainer:this.options.templatesContainer,filesContainer:this.options.filesContainer,prependFiles:false,dataType:"json",separator:",",messages:{unknownError:"Unknown error"},processdone:function(k,j){j.context.find(".upload").button("enable")},required:true,getNumberOfFiles:function(){return this.filesContainer.children().not(".processing").length},getFilesFromResponse:function(j){if(typeof(j.result)==="string"){j.result=b.parseJSON(j.result)}if(j.result&&b.isArray(j.result.files)){return j.result.files}return[]},add:function(o,m){if(o.isDefaultPrevented()){return false}var n=b(this),k,l=n.data("blueimp-fileupload"),j=l.options;if(!i.validateFile(j,m)){return}n.fileupload("process",m);m.context=i._renderUpload(m.files).data("data",m).addClass("processing");j.filesContainer[j.prependFiles?"prepend":"append"](m.context);i._forceReflow(m.context);i._transition(m.context);m.process(function(){return n.fileupload("process",m)}).always(function(){m.context.each(function(p){b(this).find(".size").text(i._formatFileSize(m.files[p].size))}).removeClass("processing")}).done(function(){m.context.find(".upload").prop("disabled",false);if((i._trigger("onSelect",o,[{file:m.files[0]}])!==false)&&(j.autoUpload||m.autoUpload)&&m.autoUpload!==false){m.submit()}}).fail(function(){if(m.files.error){m.context.each(function(q){var p=m.files[q].error;if(p){b(this).find(".error").text(p)}})}})},done:function(q,p){if(q.isDefaultPrevented()){return false}var o=b(this).data("blueimp-fileupload"),l=p.getFilesFromResponse||o.options.getFilesFromResponse,n=l(p),m,j;
if(p.context){p.context.each(function(r){var s=n[r]||{error:"Empty file upload result"};j=i._addFinishedDeferreds();i._transition(b(this)).done(function(){var t=b(this);m=i._renderDownload([s]).replaceAll(t);i._forceReflow(m);i._transition(m).done(function(){p.context=b(this);i._trigger("onSuccess",q,[{file:p.files[0]}]);i._trigger("onComplete",q,[{file:p.files[0]}]);j.resolve()})})})}else{m=i._renderDownload(n)[o.options.prependFiles?"prependTo":"appendTo"](o.options.filesContainer);i._forceReflow(m);j=i._addFinishedDeferreds();i._transition(m).done(function(){p.context=b(this);i._trigger("onSuccess",q,[{file:p.files[0]}]);i._trigger("onComplete",q,[{file:p.files[0]}]);j.resolve()})}var k=i.options.unUploadedFileList;i.clearFileList(k,p)},stop:function(l){if(l.isDefaultPrevented()){return false}var k=b(this).data("blueimp-fileupload"),j=i._addFinishedDeferreds();b.when.apply(b,i._getFinishedDeferreds()).done(function(){i._trigger("onStop",l)});i._transition(b(this).find(".fileupload-progress")).done(function(){b(this).find(".progress").attr("aria-valuenow","0").children().first().css("width","0%");b(this).find(".progress-extended").html("&nbsp;");j.resolve()})},processstart:function(j){if(j.isDefaultPrevented()){return false}b(this).addClass("fileupload-processing")},processstop:function(j){if(j.isDefaultPrevented()){return false}b(this).removeClass("fileupload-processing")},fail:function(l,j){if(l.isDefaultPrevented()){return false}var k=b(this).data("blueimp-fileupload"),n,m,o,r;if(j.context){j.context.each(function(s){if(j.errorThrown!=="abort"){var t=j.files[s];t.error=t.error||j.errorThrown||j.i18n("unknownError");r=i._addFinishedDeferreds();i._transition(b(this)).done(function(){var u=b(this);o=i._renderDownload([t]).replaceAll(u);i._forceReflow(o);i._transition(o).done(function(){j.context=b(this);i._trigger("onFail",l,[{file:j.files[0],error:j.files[0].error}]);i._trigger("onComplete",l,[{file:j.files[0]}]);r.resolve()})})}else{r=i._addFinishedDeferreds();i._transition(b(this)).done(function(){b(this).remove();
i._trigger("onRemove",l);r.resolve()})}})}else{if(j.errorThrown!=="abort"){j.context=i._renderUpload(j.files)[k.options.prependFiles?"prependTo":"appendTo"](k.options.filesContainer).data("data",j);i._forceReflow(j.context);r=i._addFinishedDeferreds();i._transition(j.context).done(function(){j.context=b(this);i._trigger("onFail",l,[{file:j.files[0],error:j.files[0].error}]);i._trigger("onComplete",l,[{file:j.files[0]}]);r.resolve()})}else{i._trigger("onFail",l,[{file:j.files[0],error:j.files[0].error}]);i._trigger("onComplete",l,[{file:j.files[0]}]);i._addFinishedDeferreds().resolve()}}var q=i.options.uploadedFileList;i.clearFileList(q,j);var p=i.options.unUploadedFileList;i.clearFileList(p,j)},progress:function(l,k){if(l.isDefaultPrevented()){return false}var j=Math.floor(k.loaded/k.total*100);if(k.context){k.context.each(function(){b(this).find(".progressbar-value").show().css("width",j+"%");b(this).find(".progressbar-text").text(j+"%")})}i._trigger("onProgress",l,[{file:k.files[0]}])},progressall:function(n,l){if(n.isDefaultPrevented()){return false}var m=b(this),k=Math.floor(l.loaded/l.total*100),j=m.find(".fileupload-progress"),o=j.find(".progress-extended");if(o.length){o.html(i._renderExtendedProgress(l))}},start:function(k){if(k.isDefaultPrevented()){return false}var j=b(this).data("blueimp-fileupload");i._resetFinishedDeferreds();i._transition(b(this).find(".fileupload-progress")).done(function(){i._trigger("onStart",k)})},send:function(k,j){if(k.isDefaultPrevented()){return false}if(j.context&&j.dataType&&j.dataType.substr(0,6)==="iframe"){j.context.find(".progress").addClass(!b.support.transition&&"progress-animated").attr("aria-valuenow",100).children().first().css("width","100%")}return i._trigger("onSend",k,[{file:j.files[0]}])},remove:function(n,m){if(n.isDefaultPrevented()){return false}var k=b(this).data("blueimp-fileupload"),l,j,o=function(){i._transition(m.context).done(function(){b(this).remove();i._trigger("onRemove",n)})};if(m.url){m.dataType=m.dataType||k.options.dataType;
b.ajax(m).done(o).fail(function(){i._trigger("onRemoveFailed",n)})}else{o()}var j=i.options.uploadedFileList;i.clearFileList(j,m)}};b.extend(true,f,this.options);this.uploaderBtn.fileupload(f);if(this.options.filesUrl){b.ajax({type:"POST",async:false,datatype:"json",url:this.options.filesUrl,data:this.options.postData,success:function(l){for(var j=0;j<l.length;j++){var k=i._renderDownload([l[j]]).appendTo(i.options.filesContainer);i._transition(k)}},error:function(j){}})}}},upload:function(d){var c=this.checkIE(),e=[];if(this.useFlash){this.uploaderBtn.swfuploader("upload",d)}else{if(d===undefined){d=this.getUnUploadValues()}this.uploaderBtn.fileupload("upload",d)}},_destroy:function(){var c=this.checkIE(),d=[];if(this.useFlash){this.uploaderBtn.swfuploader("destroy")}else{this.uploaderBtn.fileupload("destroy")}},remove:function(d){var c=this.checkIE(),e=[];if(this.useFlash){this.uploaderBtn.swfuploader("cancel",d)}else{this.uploaderBtn.fileupload("remove",d)}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(c){if(!c){c=b.Deferred()}this._finishedUploads.push(c);return c},_getFinishedDeferreds:function(){return this._finishedUploads},_enableDragToDesktop:function(){var f=b(this),d=f.prop("href"),c=f.prop("download"),e="application/octet-stream";f.bind("dragstart",function(g){try{g.originalEvent.dataTransfer.setData("DownloadURL",[e,c,d].join(":"))}catch(h){}})},_formatFileSize:function(c){if(typeof c!=="number"){return""}if(c>=1000000000){return(c/1000000000).toFixed(2)+" GB"}if(c>=1000000){return(c/1000000).toFixed(2)+" MB"}return(c/1000).toFixed(2)+" KB"},_formatBitrate:function(c){if(typeof c!=="number"){return""}if(c>=1000000000){return(c/1000000000).toFixed(2)+" Gbit/s"}if(c>=1000000){return(c/1000000).toFixed(2)+" Mbit/s"}if(c>=1000){return(c/1000).toFixed(2)+" kbit/s"}return c.toFixed(2)+" bit/s"},_formatTime:function(d){var c=new Date(d*1000),e=Math.floor(d/86400);e=e?e+"d ":"";return e+("0"+c.getUTCHours()).slice(-2)+":"+("0"+c.getUTCMinutes()).slice(-2)+":"+("0"+c.getUTCSeconds()).slice(-2)
},_formatPercentage:function(c){return(c*100).toFixed(2)+" %"},_renderExtendedProgress:function(c){return this._formatBitrate(c.bitrate)+" | "+this._formatTime((c.total-c.loaded)*8/c.bitrate)+" | "+this._formatPercentage(c.loaded/c.total)+" | "+this._formatFileSize(c.loaded)+" / "+this._formatFileSize(c.total)},_renderTemplate:function(e,d){if(!e){return b()}var c=e({files:d,formatFileSize:this._formatFileSize,options:this.options});if(c instanceof b){return c}return b(this.options.templatesContainer).html(c).children()},_renderPreviews:function(c){c.context.find(".preview").each(function(d,e){b(e).append(c.files[d].preview)})},_renderUpload:function(e,d){var c=this._renderTemplate(this.options.uploadTemplate,e);c.addClass("template-upload fade");if(c.hasClass("fade")){c.hide()}this._trigger("onRenderUploadTmp",null,{item:c});return c},_renderDownload:function(d){var c=this._renderTemplate(this.options.downloadTemplate,d).find("a[download]").each(this._enableDragToDesktop).end();c.addClass("template-download fade");if(c.hasClass("fade")){c.hide()}this._trigger("onRenderDownloadTmp",null,{item:c});return c},_forceReflow:function(c){return b.support.transition&&c.length&&c[0].offsetWidth},_transition:function(d){var c=b.Deferred();if(d.hasClass("fade")){d.fadeToggle(this.options.transitionDuration,this.options.transitionEasing,function(){c.resolveWith(d)})}else{c.resolveWith(d)}return c},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar").find(".upload, .remove"),"click");this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();this._off(this.options.filesContainer,"click");this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")
},_create:function(){var c=this.options;this.options.id=this.element.uniqueId().attr("id");this._super();this._resetFinishedDeferreds();if(!b.support.fileInput){this._disableFileInputButton()}this.element.find(".fileupload-buttonbar").find(".fileinput-button").each(function(){});c.uploadedFileList=[];c.unUploadedFileList=[];this._getConfig();if(c.beforeCreate){c.beforeCreate.apply(this)}else{this.beforeCreate()}},beforeCreate:function(){var c=this;this._on(this.options.filesContainer,{"click .upload":function(f){f.preventDefault();var d=b(f.currentTarget).closest(".template-upload");b("#"+c.element[0].id).fileuploader("upload",d[0].id)},"click .remove":function(f){f.preventDefault();var d=b(f.currentTarget).closest(".template-upload,.template-download");b("#"+c.element[0].id).fileuploader("remove",d[0].id)},"click .stop":function(f){f.preventDefault();var d=b(f.currentTarget).closest(".template-upload");b("#"+c.element[0].id).fileuploader("stop",d[0].id)}})},clearFileList:function(e,f){var d,c;if(e===this.options.uploadedFileList){d=this.getValues()}else{if(e===this.options.unUploadedFileList){d=this.getUnUploadValues()}}c=b.inArray(f.context[0][this.options.prmNames.fileId],d);if(c!==-1){e.splice(c,1)}else{e.splice(c,0)}},validateFile:function(d,g){var e=g.files[0].name.substring(g.files[0].name.lastIndexOf(".")+1);e=b.trim(e);var f=b.trim(d.acceptFileTypes);var c=this.getQueueData(),h=this.formatMaxSize(d.maxFileSize);if(c.length>=d.filesLimt){b.messageQueue({message:"Maximum number of files exceeded"});return false}if(g.files[0].size>=h){b.messageQueue({message:"The File is too large"});return false}if(f=="*.*"){return true}else{if(f.indexOf(e)==-1){b.messageQueue({message:"The file is not an accepted file type"});return false}}return true},formatMaxSize:function(d){var f=new RegExp("/^s*|s*$/"),g,e,h=1024;d=d.toLowerCase();d=d.replace(f,"");var c=d.match(/^\d+/);if(c!==null&&c.length>0){e=parseInt(c[0])}if(isNaN(e)||e<0){e=0}g=e*h;return g},getQueueData:function(){var e=[],d=[];
for(var c=0;c<this.options.uploadedFileList.length;c++){e.push(this.options.uploadedFileList[c].fileId)}for(var c=0;c<this.options.unUploadedFileList.length;c++){d.push(this.options.unUploadedFileList[c].fileId)}return b.merge(e,d)},getValues:function(){var d=[];for(var c=0;c<this.options.uploadedFileList.length;c++){d.push(this.options.uploadedFileList[c].fileId)}return d},getValidateValue:function(){var c=this.checkIE();if(this.useFlash){return this.uploaderBtn.swfuploader("getValidateValue")}else{return this.getValue()}},setValue:function(d){var c=this.checkIE();if(this.useFlash){this.uploaderBtn.swfuploader("setValues",d)}else{}},getValue:function(){var c=this.checkIE();if(this.useFlash){return this.uploaderBtn.swfuploader("getValue")}else{return this.getValues().join(this.options.separator)}},clearError:function(){},focus:function(){},getUnUploadValues:function(){var c=[];for(var d=0;d<this.options.unUploadedFileList.length;d++){c.push(this.options.unUploadedFileList[d].fileId)}return c},enable:function(){var c=this.checkIE();if(this.useFlash){this.uploaderBtn.swfuploader("disable",false)}else{var d=false;if(this.options.disabled){d=true}this._super();if(d){this.element.find("input, button").prop("disabled",false);this._enableFileInputButton();this.options.filesContainer.prop("disabled",false).removeClass("coral-state-disabled")}this.options.disabled=false;this._trigger("onEnable",null,[])}},disable:function(){var c=this.checkIE();if(this.useFlash){this.uploaderBtn.swfuploader("disable",true)}else{if(!this.options.disabled){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton();this.options.filesContainer.prop("disabled",true).addClass("coral-state-disabled")}this._super();this.options.disabled=true;this._trigger("onDisable",null,[])}}})}));