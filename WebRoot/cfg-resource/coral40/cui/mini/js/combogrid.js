(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./combo","./grid"],a)}else{a(jQuery)}}(function(a,b){a.component("coral.combogrid",a.coral.combo,{version:"4.0.3",castProperties:["colNames","colModel","data","buttonOptions","gridOptions","buttons"],options:{colNames:[],colModel:[],valueField:"id",textField:"name",panelRenderOnShow:false,multiple:false,selarrrow:[],buttons:[],url:null,panelWidth:500,panelHeight:220,sortable:false,data:[],onSelectRow:null,onSelectAll:null,onSortableColums:null,onLoad:a.noop,onComplete:null,pager:false,buttonOptions:null,gridOptions:{}},grid:function(){return a("#combo_grid_"+a(this.element).attr("id"))},button:function(){if(null!==this.options.buttonOptions){return this.$button}},_destroy:function(){this.element.removeClass("coral-validation-combogrid");this.element.removeClass("coral-form-element-combogrid");this.grid().grid("destroy");this._super()},_showItems:function(){var h=[],j=[],i=[],e=[];var d=this.options.textField,f=this.options.valueField,g={};var c=this.grid();g.filters="{}";c.grid("option","localonce",true);a.extend(c.grid("option","postData"),g);c.grid("reload",{page:1})},_doQuery:function(d){var c=this.options,l=this.grid();var e=c.textField;var k=l.grid("option","colModel"),g=[],n=[];for(var h in k){var m=k[h];if("cb"==m.name||"rn"==m.name){continue}}for(var f=0;f<d.length;f++){n.push('{"field":"'+e+'","op":"cn","data":"'+d[f]+'"}')}g.filters='{"groupOp":"OR","rules":['+n.join(",")+"]}";l.grid("option","localonce",true);a.extend(l.grid("option","postData"),g);l.grid("reload",{page:1})},_checkMathch:function(q,p){var g=[],o=[],h=[],m=[];var r=this.options.textField,c=this.options.valueField,v={},d=0,u,t;var k=this.grid();if(p){this._showItems()}var w=this.grid().grid("option","data");var n=false;var e={};if(this.options.multiple){for(u=0;u<q.length;u++){for(t=0;t<w.length;t++){if(w[t][r]!=q[u]&&w[t][c]!=q[u]){e[u.toString()]=true}if(w[t][r]==q[u]){o.push(w[t][c]);h.push(w[t][r]);n=true;break}}if(!n&&!this.options.forceSelection){if((!e[u.toString()]&&!p)||p){o.push(q[u]);
h.push(q[u])}}n=false}var f=this._getOnlyValues();var s=this._getOnlyTexts();for(u=0;u<q.length;u++){for(t=0;t<s.length;t++){if(s[t]==q[u]&&a.inArray(s[t],h)===-1){o.push(f[t]);h.push(s[t])}}}}else{var l=-1;for(u=0;u<w.length;u++){if(w[u][r]==q[0]){l=l===-1?u:l;n=true}}if(n){o.push(w[l][c]);h.push(w[l][r])}if(!n&&!this.options.forceSelection){if((!e["0"]&&!p)||p){o.push(q[0]);h.push(q[0])}}}return{valarr:o,textarr:h}},reload:function(d){this.cache.isReload=true;var c=this.grid(),f=this,e={},h=false,g=[];if(!d&&!this.options.url){d=[]}else{if(!d&&this.options.url){d=this.options.url}}if(typeof(d)!=="string"){e=d;if(e.data){g=e.data}else{if(e.url){d=e.url;h=true}else{if(d instanceof Array){g=d}else{if(!e.url&&!e.data&&!this.options.url){g=[]}else{if(!e.url&&!e.data&&this.options.url){d=this.options.url;h=true}}}}}}else{this.options.url=d;h=true}if(a.isFunction(e.onLoad)){this.cache.onLoad=e.onLoad}if(e.postData){}c.grid("reload",d)},_removeGridHighlights:function(){this._removeHighlight(this.grid().find(".coral-grid-btable tr td > span.coral-keyword-highlight"))},_addGridHighlights:function(){this._addHighlight(this.grid().find(".coral-grid-btable .jqgrow").children("td"),this.uiCombo.textbox.val())},_updateGridData:function(g){var d=this;var f=this.grid().grid("getRowData",g.rowId);var e=this._getTextFromHTML(f[this.options.valueField]);var h=this._getTextFromHTML(f[this.options.textField]);var c=a.inArray(e,this.gridValueArr);if(!this.options.multiple){this.gridValueArr=[e];this.gridTextArr=[h];this.gridRowIdArr=[g.rowId];return}if(!g.status){if(c!=-1){this.gridValueArr.splice(c,1);this.gridTextArr.splice(c,1);this.gridRowIdArr.splice(c,1)}}else{if(c==-1){this.gridValueArr.push(e);this.gridTextArr.push(h);this.gridRowIdArr.push(g.rowId)}}},_create:function(){var c=this,e=null,d;this.element.addClass("coral-form-element-combogrid coral-validation-combogrid");this._super();this.panelRendered=true;if(null!==this.options.buttonOptions){this.$button=this._getButtonEl();this.component().append(this.$button).addClass("coral-combogrid-hasButton");
this.$button.button(this.options.buttonOptions)}this.uiCombo.panel.unbind().bind("mousedown",function(g){c.cancelBlur=true;c._delay(function(){delete c.cancelBlur});var f=a(g.target).closest(".coral-grid-pager").length;if(f==1){return true}else{return false}})},_initCombo:function(){this._super();var c=a();if(this.options.pager){grid=a('<div id="combo_grid_'+a(this.element).attr("id")+'"><div class="combo_grid_'+a(this.element).attr("id")+'"></div></div>').appendTo(this.uiCombo.pContent)}else{grid=a('<div id="combo_grid_'+a(this.element).attr("id")+'"></div>').appendTo(this.uiCombo.pContent)}this.gridValueArr=[];this.gridTextArr=[];this.gridRowIdArr=[];goptions={fitStyle:"fill",keyName:this.options.valueField,sortable:this.options.sortable,colModel:this.options.colModel,colNames:this.options.colNames,multiselect:this.options.multiple,sortname:this.options.sortname,width:"auto"};goptions=a.extend({},goptions,this.options.gridOptions);if(null!=this.options.url){goptions.url=this.options.url;goptions.datatype="json"}else{goptions.data=this.options.data;goptions.datatype="local"}this._on(grid,{gridonselectrow:function(g,f){var d=this._getOnlyValues();if(this.options.multiple){if(a.inArray(f.rowId,d)==-1){d.push(f.rowId)}else{d.splice(a.inArray(f.rowId,d),1)}}else{d=[f.rowId]}this.setValues(d,true,false);if(!this.options.multiple&&g.originalEvent&&g.originalEvent.type=="click"){this.hidePanel()}},gridonselectall:function(g,f){var d=f.status?f.aRowIds.concat():[];this.setValues(d,true,false)},gridonload:function(m,k){var f=this,l=false,j=k.data;if(f.options.clearOnLoad){l=f._clearValues(j)}this._addGridHighlights();this.dataLoaded=true;var g=this.grid().grid("option","selarrrow").concat();for(var d=0;d<g.length;d++){this.grid().grid("setSelection",g[d],false)}var h=this._getOnlyValues();a.each(h,function(n,e){f.grid().grid("setSelection",e,false,null)});if(l==true){this.currentValues=[]}if(!this.search){this.setValues(this.currentValues);this.search=false}if(this.cache.isReload){this.cache.isReload=false;
this._trigger(this.cache.onLoad||"onLoad",null,[k]);delete this.cache.onLoad}}});grid.grid(goptions);grid.grid("refresh")},_getButtonEl:function(){return a("<button type='button'></button>").addClass("coral-combogrid-button")},_getRowDataByColName:function(h){var f=this,e=this.options,c=this.grid(),d=c.grid("option","data"),g=[];if(typeof h==="string"){h=[h]}a.each(d,function(k,n){var j={};for(var l in h){var m=h[l];j[m]=n[m]}g.push(j)});return g},_getTextArrByValueArr:function(k){var h=this,c=this.options,m=this.options.valueField,e=this.options.textField,d=this._getRowDataByColName([m,e]),l=[];for(var f in k){var j=k[f],g=false;a.each(d,function(i,n){if(j==n[m]){l.push(n[e]);g=true}});if(!g){l.push(k[f])}}return l},setValues:function(p,k,q){var r=this.grid();var g=r.grid("option","selarrrow").concat();for(var j=0;j<g.length;j++){r.grid("setSelection",g[j],false)}if(!this.dataLoaded){var l={setValues:{values:p,text:q,triggerOnChange:k}};this._addCacheItem(l)}var c=this.options;var n=[];n=this._getTextArrByValueArr(p);q=typeof q=="boolean"?q:false;if(!q){this._setText(n.join(c.separator))}this.currentValues=p;this.currentTexts=n;var o=p.concat();o.sort();for(var j=0;j<o.length;j++){if(o[j]!==o[j+1]&&j!=o.length||j==o.length){r.grid("setSelection",o[j],false)}}if(c.width=="item"){var e=a("<div style = 'visibility:hidden;'><span>"+this.getText()+"</span></div>").appendTo("body"),m=this.component().find(".coral-textbox-default");var f=parseInt(m.css("padding-left"))+parseInt(m.css("padding-right")),h=this.uiArrow().outerWidth()+2*parseInt(this.uiArrow().css("right")),d=e.find("span").outerWidth()+f+h;this.resize(d);e.remove();c.width="item"}this._super(p,k,false)},_getOnlyValues:function(){var g=this.getData(),c=this.options,d=[],h=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return d}for(;h<this.currentValues.length;h++){var k=this.currentValues[h],f=0,l=c.valueField,e=c.textField,m=null;if("value-text"===c.postMode){d.push(k.split(c.valueTextSeparator)[0])
}if("value"===c.postMode){d.push(k)}if("text"===c.postMode){for(;g&&f<g.length;f++){m=g[f];if(m[e]==k){d.push(m[l]);break}}}}return d},_getOnlyTexts:function(){return this.currentTexts||[]},getData:function(){return this.grid().grid("option","data")||[]},_selectPrev:function(){var f=this,e=null,c=0,g=f.grid().grid("getDataIDs");selarrrow=f.grid().grid("option","selarrrow").concat();valueFirst=f.getValues()[0];f.selectedRow=f.selectedRow||valueFirst;if(f.options.multiple){if(f.selectedRow){for(var d=g.length;d>=0;d--){if(f.selectedRow==g[d]){c=(d==0?(g.length-1):(d-1));f.selectedRow=g[c];break}}if(a.inArray(f.selectedRow,selarrrow)==-1){f.grid().grid("setSelection",f.selectedRow)}}else{f.selectedRow=g.length;f.grid().grid("setSelection",g.length)}f._scrollTo(f.selectedRow)}else{e=f.grid().grid("option","selrow");if(e){c=f.grid().grid("getInd",e);if(c>=0){f.grid().grid("setSelection",g[c-2])}}else{f.grid().grid("setSelection",g.length)}}f._scrollTo(e)},_selectNext:function(){var f=this,e=null,c=0,g=f.grid().grid("getDataIDs");selarrrow=f.grid().grid("option","selarrrow").concat();valueFirst=f.getValues()[0];f.selectedRow=f.selectedRow||valueFirst;if(f.options.multiple){if(f.selectedRow){for(var d=0;d<g.length;d++){if(f.selectedRow==g[d]){c=(d==g.length-1?0:(d+1));f.selectedRow=g[c];break}}if(a.inArray(f.selectedRow,selarrrow)==-1){f.grid().grid("setSelection",f.selectedRow)}}else{f.selectedRow=g[0];f.grid().grid("setSelection",g[0])}f._scrollTo(f.selectedRow)}else{e=f.grid().grid("option","selrow");if(e){c=f.grid().grid("getInd",e);if(c<g.length){f.grid().grid("setSelection",g[c])}}else{f.grid().grid("setSelection",g[0])}f._scrollTo(e)}},_doEnter:function(){if(!this.uiCombo.panel.is(":visible")){return}if(this.options.multiple){this.grid().grid("setSelection",this.selectedRow)}else{this.hidePanel()}},_scrollTo:function(f){var c=this.panel();var e=c.find('.coral-row-ltr[id="'+f+'"]');if(e.length){if(e.position().top<=0){var d=c.find(".coral-grid-rows-view").scrollTop()+e.position().top-e.outerHeight();
c.find(".coral-grid-rows-view").scrollTop(d)}else{if(e.position().top+e.outerHeight()>c.find(".coral-grid-rows-view").height()){var d=c.find(".coral-grid-rows-view").scrollTop()+e.position().top+e.outerHeight()-c.find(".coral-grid-rows-view").height();c.find(".coral-grid-rows-view").scrollTop(d)}}}}})}));