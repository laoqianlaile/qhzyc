/*!
 * 组件库4.0：下拉框
 * 
 * 依赖JS文件：
 *    jquery.coral.core.js
 *    jquery.coral.component.js
 *    jquery.coral.panel.js
 *    jquery.validatehelper.js
 *    jquery.coral.control.js
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./textbox","./panel"],a)}else{a(jQuery)}}(function(a,b){a(document).unbind(".coral-combobox").bind("mousedown.coral-combobox mousewheel.coral-combobox",function(g){var f=a(g.target).closest(".coral-combo-panel").length;var h=a(g.target).closest(".coral-combo").length;var d=a(g.target).closest(".coral-button").length;if(f||(h&&!d)){return}c()});function c(d,e){a(".coral-combo-wrapper").not(d).hide();a(".coral-combo-iframePanel:visible").not(e).hide()}a.component("coral.combo",a.coral.inputbase,{castProperties:["triggers"],version:"4.0.2",options:{panelRenderOnShow:false,popupDialog:false,showStar:true,showDirection:"down",labelField:null,starBefore:false,isInited:false,id:null,name:null,showOnFocus:true,iframePanel:false,buttons:[],forceSelection:true,width:"auto",height:22,placeholder:"",cls:"",required:false,errMsg:null,errMsgPosition:"leftBottom",isLabel:false,panelWidth:null,panelHeight:"auto",panelComponentCls:"",position:{my:"left top",at:"left bottom",collision:"none"},maxPanelHeight:200,multiple:false,separator:",",valueTextSeparator:"-",postMode:"value",editable:false,readonly:false,readonlyInput:true,disabled:false,clearOnLoad:true,hasArrow:true,value:"",text:"",delay:200,zIndex:10000,enableHighlight:false,enablePinyin:false,showClose:false,enableFilter:false,enterFilter:true,query:null,filter:function(i,k){var f=a(this).attr("component-role"),g=a(this)[f]("option"),d=g.textField,e=g.valueField,j=(k[d]).toLowerCase(),h=(k[e]).toString().toLowerCase();i=i.toLowerCase();if(j.indexOf(i)>-1){return"text"}if(g.enablePinyin===true){if(pinyinEngine.toPinyin(j,false,"").indexOf(i)>-1){return true}}if(h.indexOf(i)>-1){return true}else{return false}},onKeyUp:null,onKeyDown:null,onEnter:null,onBlur:null,onClick:null,onValidError:null,onValidSuccess:null,onShowPanel:a.noop,onHidePanel:a.noop,onChange:a.noop,triggers:null,excluded:false},_addCacheItem:function(d){if(typeof d!=="object"){return
}if(typeof this.cache==="undefined"){this.cache={}}this.cache=a.extend({},this.cache,d)},_getCacheItem:function(d){if(typeof d!=="string"){return}if(this.cache&&this.cache[d]){return this.cache[d]}else{return null}},_removeCacheItem:function(d){if(this.cache&&this.cache[d]){delete this.cache[d]}},_create:function(){this._prepareInit();this._initCombo();this._setDefaultValue();this._initState();this._initData();this._bindEvent()},_prepareInit:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height};this.panelRendered=false;this.dataLoaded=false;this.search=false;this.isInit=false;this.isLoaded=false;this.isInited=false;this.currentValues=[];this.cache={};if(this.options.enableSearch===true){this.options.readonlyInput=false}if(this.options.popupDialog||this.options.enableFilter){this.options.readonlyInput=true}this.element.hide();if(this.element.attr("id")){if(this.element.attr("id")!=this.options.id){this.options.id=this.element.attr("id")}}else{if(this.options.id){this.element.attr("id",this.options.id)}}if(!this.element.attr("id")){this.options.id=this.element.uniqueId().attr("id")}if(this.element.attr("name")&&this.options.name){if(this.element.attr("name")!=this.options.name){this.options.name=this.element.attr("name")}}else{if(!this.options.name&&this.element.attr("name")){this.options.name=this.element.attr("name")}}if(this.element.attr("value")&&this.options.value){if(this.element.attr("value")!=this.options.value){this.options.value=this.element.attr("value")}}else{if(!this.options.value&&this.element.attr("value")){this.options.value=this.element.attr("value")}}},_initCombo:function(){var f=null,e=null,h="",g="",d="";this.uiCombo={combo:null,panel:null};this.previousValue=null;this.uiCombo.combo=a("<span class='coral-combo coral-textbox'></span>").insertAfter(this.element);this.element.appendTo(this.uiCombo.combo);
if(this.options.hasArrow==true){if(this.options.showDirection=="down"){d="<span class='coral-combo-arrow coral-icon-arrow cui-icon-arrow-down3'></span>"}if(this.options.showDirection=="up"){d="<span class='coral-combo-arrow coral-icon-arrow cui-icon-arrow-up3'></span>"}}if(this.options.showClose&&!this.options.required){h="<span class='coral-input-clearIcon cui-icon-cross2'></span>"}this.elementBorder=a("<span class='coral-combo-border coral-textbox-border coral-corner-all'>"+h+d+"</span>").appendTo(this.uiCombo.combo);if(this.options.labelField){this.uiLabel=a('<label class="coral-label">'+this.options.labelField+"</label>");this.elementBorder.before(this.uiLabel);this.uiCombo.combo.addClass("coral-hasLabel")}this.uiCombo.textbox=a("<input type='text' autocomplete='off' class='coral-combo-text coral-combo-default coral-textbox-default'>").appendTo(this.elementBorder);if(this.options.name){this.element.removeAttr("name").attr("orgname",this.options.name);g=" name='"+this.options.name+"'"}e=a("<input type='hidden' "+g+" class='coral-combo-value'>").appendTo(this.uiCombo.combo);this.uiCombo.panel=a("<div class='coral-combo-panel "+this.options.panelComponentCls+"'></div>").appendTo("body");if(this.options.iframePanel){this.uiCombo.iframePanel=a("<iframe class='coral-combo-iframePanel' style='position:absolute;display:none;'></iframe>").appendTo("body")}this.uiCombo.pContent=a("<div class='coral-combo-content'></div>").appendTo(this.uiCombo.panel);if(this.options.enableFilter){a("<div class='coral-combo-filter'><span class='coral-combo-filter-border'><input type='text' class='coral-combo-filterbox'></span><span class='coral-combo-search cui-icon-search2'></span></div>").appendTo(this.uiCombo.panel)}var i="absolute";if(this.options.popupDialog){i="";this.uiCombo.popupDialog=a("<div class='coral-combo-popup-dialog'></div>").appendTo("body");this.uiCombo.popupInputbox=a("<input type='text' />").appendTo(this.uiCombo.popupDialog)}if(this.options.hasArrow==false){this.elementBorder.css({"padding-right":0});
this.uiCombo.textbox.css({"padding-right":0});this.uiClose().css({right:0})}this.uiCombo.panel.css({position:i}).addClass("coral-combo-wrapper "+this.options.cls+"-panel coral-front").hide();this.uiCombo.textbox.attr("placeholder",this.options.placeholder);this._showPlaceholder();if(this.options.buttons.length>0){this._createButtonPanel()}},_initState:function(){this.options.isLabel===true?this._setIsLabel(this.options.isLabel):this._setReadonly(this.options.readonly);if(!this.options.readonly){this.uiCombo.textbox.prop("readonly",this.options.readonlyInput)}this._setDisabled(this.options.disabled);this.resize()},_initData:a.noop,_setDefaultValue:function(){if(!this.options.value){this.originalValue="";return}else{this.setValue(this.options.value);this.originalValue=this.getValue()}},_showPlaceholder:function(e){if(a.support.placeholder||this.component().find(".coral-textbox-placeholder-label").length){return}e=e?e:this.options.placeholder;var d=a("<span class='coral-textbox-placeholder-label'>"+e+"</span>");a(this.uiCombo.textbox).after(d)},_hidePlaceholder:function(){if(a.support.placeholder){return}this.component().find(".coral-textbox-placeholder-label").remove()},_setIsLabel:function(d){var e=this;if(true===d){this.component().removeClass("coral-readonly");this.component().addClass("coral-isLabel");this.uiCombo.textbox.prop("readonly",true);if(this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}this.hidePanel();this.uiCombo.textbox.removeAttr("placeholder")}else{this.component().removeClass("coral-isLabel coral-readonly");this.uiCombo.textbox.prop("readonly",this.options.readonlyInput);this.options.readonly=false;this.uiCombo.textbox.attr("placeholder",this.options.placeholder)}this.options.isLabel=!!d},_setReadonly:function(d){if(d){this.element.prop("readonly",true);this.uiCombo.textbox.prop("readonly",true);this.uiCombo.combo.find(".coral-combo-value").prop("readonly",true)}else{a(this.element).prop("readonly",false);this.uiCombo.textbox.prop("readonly",false);
this.uiCombo.combo.find(".coral-combo-value").prop("readonly",false)}this.options.readonly=!!d;this.uiCombo.combo.removeClass("coral-isLabel");this.uiCombo.combo.toggleClass("coral-readonly",this.options.readonly)},_setDisabled:function(d){if(d){this.element.prop("disabled",true);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",true);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",true)}else{a(this.element).prop("disabled",false);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",false);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",false)}this.options.disabled=!!d;this.uiCombo.combo.toggleClass(this.componentFullName+"-disabled coral-state-disabled",this.options.disabled)},_selectPrev:a.noop,_selectNext:a.noop,_doEnter:a.noop,_doQuery:a.noop,_addHighlight:function(e,d){if(d===""||!e.length||!this.options.enableHighlight){return}e=a(e);var g="",h=d.replace(/[\s]+/g," ").split(" "),f;e.each(function(j,l){var i=a(l),m=a(l).parent(),k=a(l).html();if(k==d){return}if(i.hasClass(".coral-combobox-item-selected")){m.html(that._getTextFromHTML(k));return}if(!i.children("input").length){for(var o=0;o<h.length;o++){f=new RegExp(""+h[o]+"","gmi");k=k.replace(f,'<span class="coral-keyword-highlight">'+h[o]+"</span>")}i.html(k)}})},_getTextFromHTML:function(d){if(typeof d==="undefined"){return}d=d.replace(/<\/?[^>]*>/g,"");d=d.replace(/[ | ]*\n/g,"\n");d=d.replace(/&nbsp;/ig,"");return d},_clearValues:function(l){var g=this.options.valueField,e=this.currentValues,k=e.length,h,f,d=0;for(h=0;h<k;h++){for(f=0;f<l.length;f++){if(e[h]==l[f][g]){d+=1;break}}}if(d!=k){return true}else{return false}},_removeHighlight:function(d){if(!d.length||!this.options.enableHighlight){return}d=a(d);var e=this;d.each(function(f,h){var i=a(h).parent();var g=i.html();i.html(e._getTextFromHTML(g))})},focus:function(){var e=this;if(this.options.disabled||this.options.readonly||this.options.isLabel){return false}this.uiCombo.textbox.focus();if(!this.dataLoaded){var d={focus:{param:null}};
this._addCacheItem(d);return true}return true},_bindEvent:function(){var h=this,g=this.options,j=this.uiCombo.combo,d=this.uiCombo.panel,i=this.uiCombo.iframePanel;if(this.options.disabled){this.element.addClass("coral-state-disabled")}this._off(h.component());var e,f;this._on({"mouseenter.coral-combo-border":function(k){if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){return}h.uiCombo.combo.addClass("coral-textbox-hover");this._updateTitle()},"mouseleave.coral-combo-border":function(k){if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){return}h.uiCombo.combo.removeClass("coral-textbox-hover")},"keydown.coral-combo-text":function(k){this._doKeyDown(k,false)},"keyup.coral-combo-text":function(k){if(this.options.readonly||this.options.isLabel){return}this._trigger("onKeyUp",k,{})},"blur.coral-combo-text":function(k){this._setHv(k,"blur")},"focusin.coral-combo-text":function(k){if(this.options.readonly||this.options.isLabel){return}this.component().addClass("coral-state-focus");if(!e){this._trigger("onFocus",k)}},"focusout.coral-combo-text":function(k){if(this.cancelBlur){delete this.cancelBlur;return}if(this.options.readonly||this.options.isLabel){return}this._delay(function(){if(e){e=false;return}this.component().removeClass("coral-state-focus");if(f){f=false;return}this.hidePanel();this._trigger("onBlur",k)},100)},"click.coral-combo-text":function(k){if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){if(this.options.hasArrow==true&&!this.options.readOnlyInput){return}}if(h.component().hasClass("coral-state-focus")){if(this.options.popupDialog&&this.options.showOnFocus===true){this.uiCombo.popupDialog.dialog("open")}else{if(d.is(":visible")){this.hidePanel()}else{this.showPanel()}}}if(this.options.enableFilter){f=true}h._trigger("onClick",k)},"mousedown.coral-combo-arrow":function(k){if(this.component().hasClass("coral-isLabel")||this.component().hasClass("coral-readonly")){return
}if(this.component().hasClass("coral-state-focus")){e=true}},"click.coral-combo-arrow":function(k){c(d,i);if(h.component().hasClass("coral-isLabel")||h.component().hasClass("coral-readonly")){return}if(h.component().hasClass("coral-state-focus")){e=true}if(this.options.enableFilter){f=true}this.focus();if(h.options.popupDialog){h.uiCombo.popupDialog.dialog("open")}else{if(d.is(":visible")){h.hidePanel()}else{h.showPanel()}}},"click.coral-input-clearIcon":function(k){if(this.component().hasClass("coral-state-focus")){e=true}this.clear();if(this.options.placeholder){this._showPlaceholder()}},combogridonshowpanel:function(k){h._removeGridHighlights();h._scrollTo(h.getValue());h.grid().grid("refresh")}});this._on(this.uiCombo.panel.find(".coral-combo-filterbox"),{keydown:function(k){this._doKeyDown(k,true)}});this._on(this.uiCombo.panel.find(".coral-combo-search"),{click:function(k){k.preventDefault();this._filter(k,true);return false}});this._on(this.uiCombo.panel.find(".coral-combo-filterbox"),{focusout:function(k){this._delay(function(){this.hidePanel()},100)}})},_updateTitle:function(){var d=a("<span style = 'visibility: hidden'>"+this.getText()+"</span>").appendTo("body");if(this.component().outerWidth()<d.width()){this.component().attr("title",this.getText())}d.remove()},_doKeyDown:function(i,f){var g=this.options,d=this.panel();this.previousValue=a(i.target).val();if(g.readonly||g.isLabel){return}var h=a.coral.keyCode;switch(i.keyCode){case h.TAB:break;case h.ENTER:i.preventDefault();this._doEnter(i);this._setHv(i);this._trigger("onEnter",i,{});break;case h.ESCAPE:this.hidePanel();break;case h.UP:i.preventDefault();if(g.readonly===false){if(!d.is(":visible")){this.showPanel()}else{if(g.onSelectPrev){this._trigger("onSelectPrev",i)}else{this._selectPrev(i)}}}break;case h.DOWN:i.preventDefault();if(g.readonly===false){if(!d.is(":visible")){this.showPanel()}else{if(g.onSelectNext){this._trigger("onSelectNext",i)}else{this._selectNext(i)}}}break;default:this._filter(i,f);
break}this._hidePlaceholder();this._trigger("onKeyDown",i)},_setHv:function(j,g){var k=a(j.target),f=[],d=k.val();if(this.options.multiple){d=d.split(this.options.separator)}else{d=[d]}this._showItems();var i=true;if(g=="blur"){i=d.toString()!=this.previousValue}if(i){var h=this.options.textField,m=this.options.valueField;var l=this._checkMathch(d,true);if(!l){k.val("");this.setValues([""])}else{this.setValues(l.valarr)}}},_searchFilter:a.noop,_filter:function(i,f){var h=this,g=this.options,d=this.panel();if(h.timer){clearTimeout(h.timer)}if(!d.is(":visible")){h.showPanel()}h.timer=setTimeout(function(){var l=a(i.target).val();if(f){l=d.find(".coral-combo-filterbox").val()}if(h.options.multiple){l=l.split(g.separator)}else{l=[l]}if(l==h.previousValue){return}if(g.query){g.query.call(h.element,l)}else{h.search=true;h._doQuery(l)}var k=h.options.textField,j=h.options.valueField;if(!f){var e=h._checkMathch(l,false);h.setValues(e.valarr,false,true)}h.resizeIframePanel()},g.delay);return false},_formatValue:function(d){return d},_setOption:function(d,e){if(d==="id"||d==="name"){return}if(d==="readonly"){this._setReadonly(e)}if(d==="disabled"){this._setDisabled(e)}if(d==="data"){this.data=e}this._super(d,e);if(d==="isLabel"){this._setIsLabel(e);return}},_destroy:function(){this.panel().remove();if(this.options.iframePanel){this.uiCombo.iframePanel.remove()}this.component().replaceWith(this.element);if(this.options.name){this.element.removeAttr("orgname").attr("name",this.options.name)}this.element.show();this.element.css(this.originalCss)},component:function(){return this.uiCombo.combo},panel:function(){return this.uiCombo.panel},uiArrow:function(){return this.uiCombo.combo.find("span.coral-combo-arrow")},uiClose:function(){return this.uiCombo.combo.find("span.coral-input-clearIcon")},uiBorder:function(){return this.component().find("span.coral-combo-border")},resize:function(h){var i=this.options,j=this.uiCombo.combo,f=this.uiCombo.panel,e=this.elementBorder;if(h){i.width=h
}if(i.width=="auto"||i.width=="item"){return}if(isNaN(i.width)){var g=this.element.parent(":first"),d=null;h=this.element.outerWidth();if(g&&g.get(0).tagName!=="BODY"){d=g.outerWidth();if(d<h){h=d}}i.width=h}j.outerWidth(i.width)},resizeIframePanel:function(){var f=this.options,d,h=this.uiCombo.combo,e=this.uiCombo.panel,g=this.uiCombo.iframePanel||a();d=e.height();g.css("height",d)},_initPanel:function(){var g=this.options,h=this.uiCombo.combo,e=this.elementBorder,d=this.uiCombo.panel,f=g.panelHeight;if(!this.panelRendered){this._renderItems(this.options.data);this.uiCombo.pContent.html(this.lazyPanelHtml);this.panelRendered=true;this.lazyPanelHtml=""}d.css("width",(g.panelWidth?g.panelWidth:e.outerWidth()));d.css("height",f);if(isNaN(f)){this.uiCombo.pContent.css({"max-height":g.maxPanelHeight+"px"});this.uiCombo.popupDialogTree&&this.uiCombo.popupDialogTree.css({"max-height":g.maxPanelHeight+"px"})}if(this.options.enableFilter&&!isNaN(f)){this.uiCombo.pContent.height(g.panelHeight-30)}else{if(f=="auto"){this.uiCombo.pContent.height("")}else{this.uiCombo.pContent.height(f-2)}}if(this.options.iframePanel){this.uiCombo.iframePanel.css("height",d.outerHeight())}},showPanel:function(){var i=this,d=this.options,f=this.uiCombo.combo,h=this.elementBorder,l=this.options.showDirection,e=this.uiCombo.panel,g=this.uiCombo.iframePanel||a();if(e.is(":hidden")){var k=a(".coral-front:visible").map(function(){return +a(this).css("z-index")}).get(),j=Math.max.apply(null,k);if(j>=+e.css("z-index")){e.css("z-index",j+1);if(this.options.iframePanel){g.css("z-index",j)}}if(!this._PanelInited){this._initPanel()}this._PanelInited=true;e.show(0,function(){i.resizeIframePanel();g.show();(function m(){if(e.is(":visible")){e.css({left:a.coral.getLeft(e,h),top:a.coral.getTop(e,h,l),width:(d.panelWidth?d.panelWidth:h.outerWidth())});if(i.options.iframePanel){g.css({left:a.coral.getLeft(g,h),top:a.coral.getTop(g,f,l),width:(d.panelWidth?d.panelWidth:h.outerWidth())})}setTimeout(m,200)}})();i.uiCombo.panel.find(".coral-combo-filterbox").focus();
i._trigger("onShowPanel",null,{})})}if(d.enableFilter){this.setValues(this.getValues())}},hidePanel:function(){this.uiCombo.panel.hide();if(this.uiCombo.iframePanel){this.uiCombo.iframePanel.hide()}this._trigger("onHidePanel",null,{})},disable:function(){this._setDisabled(true)},enable:function(){this._setDisabled(false)},show:function(){this._super()},hide:function(){this._super();this.hidePanel()},hideErrors:function(){a.validate.hideErrors(this.uiBorder());this.component().removeClass("coral-combo-error")},clear:function(){this.setValues([],true,false)},getOldText:function(){return this.oldText},reset:function(){this.setValue(this.originalValue)},getText:function(){return this.uiCombo.combo.find("input.coral-combo-text").val()},_setText:function(d){var e=this.uiCombo.combo.find("input.coral-combo-text");e.val(d);this.previousValue=d},setText:function(d){this._setText(d)},getValues:function(){var d=[];if(!this.dataLoaded){return this.currentValues}this.uiCombo.combo.find("input.coral-combo-value").each(function(){d.push(a(this).val())});return d},setValues:function(d,l,k){var v=this.getValues(),m=null,n=this.options,r=0,h=[],g=[];d=d||[];this.oldValues=v;var t=[],w="",p="";this.uiCombo.combo.find("input.coral-combo-value").remove();for(r=0;r<d.length;r++){w="";p="";if(this.options.name){w=" name='"+this.options.name+"' "}t.push("<input type='hidden' "+w+" value='"+this._formatValue(d[r])+"' class='coral-combo-value' />")}this.uiCombo.combo.append(t.join(""));for(r=0;r<v.length;r++){h[r]=v[r]}for(r=0;r<d.length;r++){for(var q=0;q<h.length;q++){if(d[r]==h[q]){g.push(d[r]);h.splice(q,1);break}}}if(d.length){if(this.options.placeholder){this._hidePlaceholder()}}if(n.width=="item"){var e=a("<div style = 'visibility:hidden;'><span>"+this.getText()+"</span></div>").appendTo("body"),f=this.component().find(".coral-textbox-default");var u=parseInt(f.css("padding-left"))+parseInt(f.css("padding-right")),s=this.uiArrow().outerWidth()+2*parseInt(this.uiArrow().css("right")),o=e.find("span").outerWidth()+u+s;
this.resize(o);e.remove();n.width="item"}if((g.length!=d.length||d.length!=v.length)&&(!k)&&l){if(this.options.multiple){this._trigger("onChange",null,{value:d,newValue:d,newText:this.getText(),text:this.getText(),oldValue:v,oldText:this.getOldText()})}else{this._trigger("onChange",null,{value:d[0],newValue:d[0],newText:this.getText(),text:this.getText(),oldValue:v[0],oldText:this.getOldText()})}}},getValue:function(){return this.getValues().join(this.options.separator)},setValue:function(f,d,e){f=f||"";f=f.split(this.options.separator);this.setValues(f,d)},getSelectedItems:function(){var g=this.getValues(),l=[];var e=this.options.data;for(var f=0;f<g.length;f++){for(var d=0;d<e.length;d++){var k=e[d];if(g[f]==k.id){for(var h in k){l.push(h+"="+k[h]+"\n")}}}}return l},refresh:function(){this.destroy();this.component().remove();this._create()}})}));